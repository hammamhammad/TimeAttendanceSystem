<!-- Loading State -->
@if (loading()) {
  <app-loading-spinner [message]="i18n.t('common.loading')"></app-loading-spinner>
}

<!-- Error State -->
@if (error() && !loading()) {
  <div class="alert alert-danger">
    <i class="bi bi-exclamation-triangle me-2"></i>
    {{ error() }}
    <button class="btn btn-sm btn-outline-danger ms-3" (click)="onBack()" type="button">
      {{ i18n.t('common.back') }}
    </button>
  </div>
}

<!-- Details View -->
@if (excuse() && !loading() && !error()) {
  <div class="excuse-details">
    <!-- Page Header -->
    <app-page-header [title]="i18n.t('portal.excuse_details')">
      <div header-actions>
        <!-- Approval Actions (for managers viewing pending requests) -->
        @if (canApprove()) {
          <button
            class="btn btn-success btn-sm me-2"
            (click)="onApprove()"
            [disabled]="processingApproval()"
            type="button">
            @if (processingApproval()) {
              <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
            } @else {
              <i class="bi bi-check-circle me-1"></i>
            }
            {{ i18n.t('portal.approve') }}
          </button>
          <button
            class="btn btn-danger btn-sm me-2"
            (click)="onReject()"
            [disabled]="processingApproval()"
            type="button">
            @if (processingApproval()) {
              <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
            } @else {
              <i class="bi bi-x-circle me-1"></i>
            }
            {{ i18n.t('portal.reject') }}
          </button>
          <button
            class="btn btn-info btn-sm me-2"
            (click)="onDelegate()"
            [disabled]="processingApproval()"
            type="button">
            @if (processingApproval()) {
              <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
            } @else {
              <i class="bi bi-person-plus me-1"></i>
            }
            {{ i18n.t('portal.delegate') }}
          </button>
        }
        @if (canEdit()) {
          <button
            class="btn btn-primary btn-sm me-2"
            (click)="onEdit()"
            type="button">
            <i class="bi bi-pencil me-1"></i>
            {{ i18n.t('common.edit') }}
          </button>
        }
        @if (canCancel()) {
          <button
            class="btn btn-danger btn-sm me-2"
            (click)="onCancel()"
            type="button">
            <i class="bi bi-x me-1"></i>
            {{ i18n.t('common.cancel') }}
          </button>
        }
        <button
          class="btn btn-outline-secondary btn-sm"
          (click)="onBack()"
          type="button">
          <i class="bi bi-arrow-left me-1"></i>
          {{ i18n.t('common.back') }}
        </button>
      </div>
    </app-page-header>

    <!-- Status Badge -->
    <div class="status-section mb-4">
      <label class="status-label">{{ i18n.t('portal.status') }}</label>
      <app-status-badge
        [status]="statusBadge().label"
        [variant]="statusBadge().variant">
      </app-status-badge>
    </div>

    <!-- Request Details Card -->
    <app-detail-card [title]="i18n.t('portal.request_details')">
      <app-definition-list
        [items]="basicInfoItems()"
        [labelWidth]="'4'"
        [valueWidth]="'8'">
      </app-definition-list>
    </app-detail-card>

    <!-- Submission Information Card -->
    <app-detail-card
      [title]="i18n.t('portal.submission_information')"
      class="mt-3">
      <app-definition-list
        [items]="submissionInfoItems()"
        [labelWidth]="'4'"
        [valueWidth]="'8'">
      </app-definition-list>
    </app-detail-card>

    <!-- Attachment Section -->
    @if (excuse()!.attachmentPath || excuse()!.attachmentUrl) {
      <app-detail-card
        [title]="i18n.t('portal.attachment')"
        class="mt-3">
        <div class="attachment-section">
          <i class="bi bi-file-earmark me-2 text-primary"></i>
          <a
            [href]="excuse()!.attachmentPath || excuse()!.attachmentUrl"
            target="_blank"
            rel="noopener noreferrer"
            class="attachment-link">
            {{ i18n.t('portal.view_attachment') }}
            <i class="bi bi-box-arrow-up-right ms-1"></i>
          </a>
        </div>
      </app-detail-card>
    }

    <!-- Status Information -->
    @if (excuse()!.approvalStatusDisplay === 'Approved' || excuse()!.status === 'Approved') {
      <div class="alert alert-success mt-3">
        <i class="bi bi-check-circle me-2"></i>
        {{ i18n.t('portal.excuse_approved_message') }}
      </div>
    } @else if (excuse()!.approvalStatusDisplay === 'Rejected' || excuse()!.status === 'Rejected') {
      <div class="alert alert-danger mt-3">
        <i class="bi bi-x-circle me-2"></i>
        {{ i18n.t('portal.excuse_rejected_message') }}
        @if (excuse()!.rejectionReason) {
          <div class="mt-2">
            <strong>{{ i18n.t('portal.rejection_reason') }}:</strong> {{ excuse()!.rejectionReason }}
          </div>
        }
      </div>
    } @else if (isExcuseExpired()) {
      <!-- Workflow actually expired (timed out) -->
      <div class="alert alert-danger mt-3">
        <i class="bi bi-x-circle me-2"></i>
        {{ i18n.t('portal.excuse_expired_message') }}
      </div>
    } @else if (excuse()!.approvalStatusDisplay === 'Pending' || excuse()!.status === 'Pending') {
      <!-- Not approved - still pending workflow approval -->
      <div class="alert alert-warning mt-3">
        <i class="bi bi-clock me-2"></i>
        @if (isApprovalView()) {
          <!-- Manager viewing for approval -->
          <span>{{ i18n.t('portal.excuse_awaiting_your_approval') }}</span>
        } @else {
          <!-- Requester viewing their own request -->
          <span>{{ i18n.t('portal.excuse_pending_message') }}</span>
          @if (pendingApprovalInfo()?.pendingWith) {
            <div class="mt-2">
              <strong>{{ i18n.t('portal.pending_with') }}:</strong> {{ pendingApprovalInfo()!.pendingWith }}
              @if (pendingApprovalInfo()?.stepProgress) {
                <span class="ms-2 text-muted">({{ i18n.t('portal.step') }} {{ pendingApprovalInfo()!.stepProgress }})</span>
              }
            </div>
          }
        }
      </div>
    }

    <!-- Approval History Section -->
    @if (excuse()?.approvalHistory && excuse()!.approvalHistory!.length > 0) {
      <app-detail-card
        [title]="i18n.t('portal.approval_history')"
        class="mt-3">
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0">
            <thead>
              <tr>
                <th>{{ i18n.t('portal.step_name') }}</th>
                <th>{{ i18n.t('portal.status') }}</th>
                <th>{{ i18n.t('portal.assigned_to') }}</th>
                <th>{{ i18n.t('portal.action_by') }}</th>
                <th>{{ i18n.t('portal.assigned_date') }}</th>
                <th>{{ i18n.t('portal.action_date') }}</th>
                <th>{{ i18n.t('portal.comments') }}</th>
              </tr>
            </thead>
            <tbody>
              @for (step of excuse()!.approvalHistory; track step.stepOrder) {
                <tr>
                  <td>{{ step.stepName }}</td>
                  <td>
                    <app-status-badge
                      [label]="getStepStatusLabel(step.status)"
                      [variant]="getStepStatusVariant(step.status)">
                    </app-status-badge>
                  </td>
                  <td>{{ step.assignedToName }}</td>
                  <td>{{ step.actionByName || '-' }}</td>
                  <td>{{ formatDateTime(step.assignedAt) }}</td>
                  <td>{{ step.actionAt ? formatDateTime(step.actionAt) : '-' }}</td>
                  <td>{{ step.comments || '-' }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </app-detail-card>
    }
  </div>
}

<!-- Delegation Modal -->
<app-delegation-modal
  [show]="showDelegationModal()"
  [title]="i18n.t('portal.delegate_approval')"
  (close)="onCloseDelegationModal()"
  (delegate)="onDelegateConfirmed($event)">
</app-delegation-modal>
