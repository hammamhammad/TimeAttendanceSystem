import{a as J}from"./chunk-24B36L4T.js";import{a as N,b as A,c as h,d as B,e as L,h as q,k as D,l as V,m as G,n as $,o as z,r as j,t as Z}from"./chunk-RH4QBYEM.js";import{g as U,h as T,m as R}from"./chunk-4DYU65FO.js";import{b as H}from"./chunk-CQWUHIOF.js";import{$a as a,Ca as O,Ia as F,Lb as M,Q as C,Ta as m,Ua as u,V as S,W as w,Xa as I,Ya as E,Za as p,_a as o,ab as d,ca as x,ea as P,eb as y,ec as k,gb as _,ib as l,nb as f,qb as s,ra as n,rb as v,sb as c}from"./chunk-LHYYCVNR.js";var Q=(r,t)=>t.id;function W(r,t){if(r&1&&(o(0,"div",16),d(1,"i",40),s(2),a()),r&2){let e=l();n(2),c(" ",e.error()," ")}}function X(r,t){if(r&1&&(o(0,"div",22),s(1),a()),r&2){let e=l(2);n(),v(e.getFieldError("username"))}}function Y(r,t){if(r&1&&(o(0,"div",18)(1,"label",19),s(2),o(3,"span",20),s(4,"*"),a()(),d(5,"input",41),m(6,X,2,1,"div",22),a()),r&2){let e=l();n(2),c("",e.t("users.username")," "),n(3),f("is-invalid",e.isFieldInvalid("username")),p("placeholder",e.t("users.username")),n(),u(e.isFieldInvalid("username")?6:-1)}}function ee(r,t){if(r&1&&(o(0,"div",22),s(1),a()),r&2){let e=l();n(),v(e.getFieldError("email"))}}function te(r,t){if(r&1&&(o(0,"div",22),s(1),a()),r&2){let e=l();n(),v(e.getFieldError("phone"))}}function ie(r,t){if(r&1&&(o(0,"div",22),s(1),a()),r&2){let e=l(2);n(),v(e.getFieldError("password"))}}function ne(r,t){if(r&1&&(o(0,"div",18)(1,"label",19),s(2),o(3,"span",20),s(4,"*"),a()(),d(5,"input",42),m(6,ie,2,1,"div",22),o(7,"small",43),s(8," Must be at least 8 characters with uppercase, lowercase, digit, and special character. "),a()()),r&2){let e=l();n(2),c("",e.t("users.password")," "),n(3),f("is-invalid",e.isFieldInvalid("password")),p("placeholder",e.t("users.password")),n(),u(e.isFieldInvalid("password")?6:-1)}}function re(r,t){if(r&1&&(o(0,"div",22),s(1),a()),r&2){let e=l(2);n(),v(e.getFieldError("confirmPassword"))}}function oe(r,t){if(r&1&&(o(0,"div",18)(1,"label",19),s(2),o(3,"span",20),s(4,"*"),a()(),d(5,"input",44),m(6,re,2,1,"div",22),a()),r&2){let e=l();n(2),c("",e.t("users.confirm_password")," "),n(3),f("is-invalid",e.isFieldInvalid("confirmPassword")),p("placeholder",e.t("users.confirm_password")),n(),u(e.isFieldInvalid("confirmPassword")?6:-1)}}function ae(r,t){if(r&1&&(o(0,"div",22),s(1),a()),r&2){let e=l();n(),v(e.getFieldError("preferredLanguage"))}}function se(r,t){if(r&1&&(o(0,"div",18)(1,"label",19),s(2),a(),o(3,"div",45),d(4,"input",46),o(5,"label",47),s(6),a()()()),r&2){let e=l();n(2),v(e.t("common.status")),n(4),c(" ",e.t("common.active")," ")}}function le(r,t){if(r&1){let e=y();o(0,"div",48)(1,"div",49)(2,"input",50),_("change",function(){let g=S(e).$implicit,b=l(2);return w(b.onRoleToggle(g.id))}),a(),o(3,"label",51),d(4,"i",52),s(5),a()()()}if(r&2){let e=t.$implicit,i=l(2);n(2),p("id","role-"+e.id)("checked",i.isRoleSelected(e.id)),n(),p("for","role-"+e.id),n(2),c(" ",e.name," ")}}function de(r,t){if(r&1&&(o(0,"div",17),I(1,le,6,4,"div",48,Q),a()),r&2){let e=l();n(),E(e.availableRoles())}}function ce(r,t){if(r&1&&(o(0,"div",32),d(1,"i",53),s(2),a()),r&2){let e=l();n(2),c(" ",e.t("common.loading"),"... ")}}function me(r,t){if(r&1&&(o(0,"div",33),d(1,"i",54),s(2),a()),r&2){let e=l();n(2),c(" ",e.getFieldError("roleIds")," ")}}function ue(r,t){if(r&1){let e=y();o(0,"div",48)(1,"div",49)(2,"input",50),_("change",function(){let g=S(e).$implicit,b=l(2);return w(b.onBranchToggle(g.id))}),a(),o(3,"label",51),d(4,"i",55),s(5),a()()()}if(r&2){let e=t.$implicit,i=l(2);n(2),p("id","branch-"+e.id)("checked",i.isBranchSelected(e.id)),n(),p("for","branch-"+e.id),n(2),c(" ",e.name," ")}}function pe(r,t){if(r&1&&(o(0,"div",17),I(1,ue,6,4,"div",48,Q),a()),r&2){let e=l();n(),E(e.availableBranches())}}function ve(r,t){if(r&1&&(o(0,"div",32),d(1,"i",53),s(2),a()),r&2){let e=l();n(2),c(" ",e.t("common.loading"),"... ")}}function he(r,t){r&1&&d(0,"span",39)}function ge(r,t){if(r&1&&(d(0,"i",56),s(1)),r&2){let e=l();n(),c(" ",e.t("common.save")," ")}}function be(r,t){if(r&1&&(d(0,"i",57),s(1)),r&2){let e=l();n(),c(" ",e.t("users.create_user")," ")}}var K=class r{user=null;show=!1;showChange=new F;userSaved=new F;userCreated=new F;fb=C(j);usersService=C(J);router=C(U);i18n=C(H);userForm;loading=x(!1);error=x("");availableRoles=x([]);availableBranches=x([]);isEditMode=M(()=>!!this.user);isSystemAdmin=M(()=>this.user?.username?.toLowerCase()==="systemadmin");modalTitle=M(()=>this.isEditMode()?this.t("users.edit_user"):this.t("users.create_user"));ngOnInit(){this.initializeForm(),this.loadRoles(),this.loadBranches()}ngOnChanges(){this.userForm&&this.user&&this.populateForm()}t(t){return this.i18n.t(t)}initializeForm(){let t=this.isSystemAdmin(),e=!this.isEditMode();this.userForm=this.fb.group({username:[{value:"",disabled:this.isEditMode()||t},[h.required,h.minLength(3)]],email:[{value:"",disabled:t},[h.required,h.email]],phone:[{value:"",disabled:t}],password:[{value:"",disabled:!e||t},e?[h.required,h.minLength(8),h.pattern(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^\da-zA-Z]).{8,}$/)]:[]],confirmPassword:[{value:"",disabled:!e||t},e?[h.required]:[]],preferredLanguage:[{value:"en",disabled:t},h.required],roleIds:[{value:[],disabled:t},h.required],branchIds:[{value:[],disabled:t}]}),e&&this.userForm.get("confirmPassword")?.setValidators([h.required,this.passwordMatchValidator.bind(this)]),this.isEditMode()&&this.userForm.addControl("isActive",this.fb.control({value:!0,disabled:t})),this.user&&this.populateForm()}populateForm(){if(!this.user||!this.userForm)return;let t=(this.user.roles||[]).map(i=>this.availableRoles().find(b=>b.name===i)?.id||0).filter(i=>i>0),e=(this.user.branches||[]).map(i=>this.availableBranches().find(b=>b.name===i)?.id||0).filter(i=>i>0);this.userForm.patchValue({username:this.user.username,email:this.user.email,phone:this.user.phone||"",preferredLanguage:this.user.preferredLanguage,roleIds:t,branchIds:e,isActive:this.user.isActive})}onSubmit(){if(this.userForm.invalid){this.userForm.markAllAsTouched();return}if(this.isSystemAdmin()){this.error.set(this.t("users.cannot_edit_system_admin"));return}this.loading.set(!0),this.error.set("");let t=this.userForm.value;this.isEditMode()?this.updateUser(t):this.createUser(t)}createUser(t){let e={username:t.username,email:t.email,phone:t.phone||void 0,password:t.password,preferredLanguage:t.preferredLanguage,roleIds:t.roleIds,branchIds:t.branchIds};this.usersService.createUser(e).subscribe({next:i=>{this.loading.set(!1),this.usersService.getUserById(i.id).subscribe({next:g=>{this.userCreated.emit(g),this.closeModal()}})},error:i=>{this.loading.set(!1),this.error.set(this.getErrorMessage(i))}})}updateUser(t){if(!this.user)return;let e={email:t.email,phone:t.phone||void 0,preferredLanguage:t.preferredLanguage,isActive:t.isActive};this.usersService.updateUser(this.user.id,e).subscribe({next:()=>{this.loading.set(!1),this.usersService.getUserById(this.user.id).subscribe({next:i=>{this.userSaved.emit(i),this.closeModal()}})},error:i=>{this.loading.set(!1),this.error.set(this.getErrorMessage(i))}})}onRoleToggle(t){let e=this.userForm.get("roleIds")?.value||[],i=e.indexOf(t);i>-1?e.splice(i,1):e.push(t),this.userForm.get("roleIds")?.setValue([...e]),this.userForm.get("roleIds")?.markAsTouched()}onBranchToggle(t){let e=this.userForm.get("branchIds")?.value||[],i=e.indexOf(t);i>-1?e.splice(i,1):e.push(t),this.userForm.get("branchIds")?.setValue([...e])}isRoleSelected(t){return(this.userForm.get("roleIds")?.value||[]).includes(t)}isBranchSelected(t){return(this.userForm.get("branchIds")?.value||[]).includes(t)}closeModal(){this.router.navigate(["/users"])}getErrorMessage(t){return t?.error?.error?t.error.error:this.t("errors.unknown")}getFieldError(t){let e=this.userForm.get(t);if(e?.errors&&e.touched){if(e.errors.required)return this.t("validation.required");if(e.errors.email)return this.t("validation.email");if(e.errors.minlength)return this.t("validation.minlength").replace("{{min}}",e.errors.minlength.requiredLength);if(e.errors.pattern&&t==="password")return"Password must contain at least one lowercase letter, one uppercase letter, one digit, and one special character.";if(e.errors.passwordMismatch)return"Passwords do not match."}return""}passwordMatchValidator(t){let e=this.userForm?.get("password")?.value,i=t.value;return e===i?null:{passwordMismatch:!0}}loadRoles(){this.usersService.getRoles().subscribe({next:t=>{this.availableRoles.set(t)},error:t=>{console.error("Failed to load roles:",t)}})}loadBranches(){this.usersService.getBranches().subscribe({next:t=>{this.availableBranches.set(t)},error:t=>{console.error("Failed to load branches:",t)}})}isFieldInvalid(t){let e=this.userForm.get(t);return!!(e?.errors&&e.touched)}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=O({type:r,selectors:[["app-user-form"]],inputs:{user:"user",show:"show"},outputs:{showChange:"showChange",userSaved:"userSaved",userCreated:"userCreated"},features:[P],decls:84,vars:39,consts:[[1,"container-fluid"],[1,"d-flex","justify-content-between","align-items-center","mb-4"],["aria-label","breadcrumb"],[1,"breadcrumb"],[1,"breadcrumb-item"],["routerLink","/dashboard"],["routerLink","/users"],[1,"breadcrumb-item","active"],["type","button",1,"btn","btn-outline-secondary",3,"click","disabled"],[1,"fa-solid","fa-arrow-left","me-2"],[1,"card"],[1,"card-header"],[1,"card-title","mb-0"],[1,"fa-solid","fa-user","me-2"],[1,"card-body"],[3,"ngSubmit","formGroup"],["role","alert",1,"alert","alert-danger"],[1,"row","g-3"],[1,"col-md-6"],[1,"form-label"],[1,"text-danger"],["type","email","formControlName","email",1,"form-control",3,"placeholder"],[1,"invalid-feedback"],["type","tel","formControlName","phone",1,"form-control",3,"placeholder"],["formControlName","preferredLanguage",1,"form-select"],["value","en"],["value","ar"],[1,"col-12","mb-4"],[1,"text-primary","mb-3","border-bottom","pb-2"],[1,"fa-solid","fa-shield-alt","me-2"],[1,"mb-3"],[1,"border","rounded","p-3","bg-light"],[1,"text-muted","text-center","py-3"],[1,"text-danger","small","mt-2"],[1,"form-text","text-muted","d-block","mt-3","px-2"],[1,"fa-solid","fa-info-circle","me-1","text-info"],[1,"d-flex","justify-content-end","gap-2","mt-4"],[1,"fa-solid","fa-times","me-2"],["type","submit",1,"btn","btn-primary",3,"disabled"],["role","status","aria-hidden","true",1,"spinner-border","spinner-border-sm","me-2"],[1,"fa-solid","fa-exclamation-triangle","me-2"],["type","text","formControlName","username",1,"form-control",3,"placeholder"],["type","password","formControlName","password",1,"form-control",3,"placeholder"],[1,"form-text","text-muted"],["type","password","formControlName","confirmPassword",1,"form-control",3,"placeholder"],[1,"form-check","form-switch","mt-2"],["type","checkbox","role","switch","id","isActiveSwitch","formControlName","isActive",1,"form-check-input"],["for","isActiveSwitch",1,"form-check-label"],[1,"col-md-6","col-lg-4"],[1,"form-check","p-2","border","rounded","bg-white"],["type","checkbox",1,"form-check-input",3,"change","id","checked"],[1,"form-check-label","fw-medium",3,"for"],[1,"fa-solid","fa-shield-alt","me-2","text-primary"],[1,"fa-solid","fa-spinner","fa-spin","me-2"],[1,"fa-solid","fa-exclamation-triangle","me-1"],[1,"fa-solid","fa-building","me-2","text-success"],[1,"fa-solid","fa-save","me-2"],[1,"fa-solid","fa-plus","me-2"]],template:function(e,i){e&1&&(o(0,"div",0)(1,"div",1)(2,"div")(3,"h2"),s(4),a(),o(5,"nav",2)(6,"ol",3)(7,"li",4)(8,"a",5),s(9),a()(),o(10,"li",4)(11,"a",6),s(12),a()(),o(13,"li",7),s(14),a()()()(),o(15,"button",8),_("click",function(){return i.closeModal()}),d(16,"i",9),s(17),a()(),o(18,"div",10)(19,"div",11)(20,"h5",12),d(21,"i",13),s(22),a()(),o(23,"div",14)(24,"form",15),_("ngSubmit",function(){return i.onSubmit()}),m(25,W,3,1,"div",16),o(26,"div",17),m(27,Y,7,5,"div",18),o(28,"div",18)(29,"label",19),s(30),o(31,"span",20),s(32,"*"),a()(),d(33,"input",21),m(34,ee,2,1,"div",22),a(),o(35,"div",18)(36,"label",19),s(37),a(),d(38,"input",23),m(39,te,2,1,"div",22),a(),m(40,ne,9,5,"div",18),m(41,oe,7,5,"div",18),o(42,"div",18)(43,"label",19),s(44),o(45,"span",20),s(46,"*"),a()(),o(47,"select",24)(48,"option",25),s(49,"English"),a(),o(50,"option",26),s(51,"\u0627\u0644\u0639\u0631\u0628\u064A\u0629"),a()(),m(52,ae,2,1,"div",22),a(),m(53,se,7,2,"div",18),o(54,"div",27)(55,"h6",28),d(56,"i",29),s(57),a(),o(58,"div",30)(59,"label",19),s(60),o(61,"span",20),s(62,"*"),a()(),o(63,"div",31),m(64,de,3,0,"div",17)(65,ce,3,1,"div",32),m(66,me,3,1,"div",33),a()(),o(67,"div",30)(68,"label",19),s(69),a(),o(70,"div",31),m(71,pe,3,0,"div",17)(72,ve,3,1,"div",32),o(73,"small",34),d(74,"i",35),s(75),a()()()()(),o(76,"div",36)(77,"button",8),_("click",function(){return i.closeModal()}),d(78,"i",37),s(79),a(),o(80,"button",38),m(81,he,1,0,"span",39),m(82,ge,2,1)(83,be,2,1),a()()()()()()),e&2&&(n(4),v(i.modalTitle()),n(5),v(i.t("dashboard.title")),n(3),v(i.t("users.title")),n(2),v(i.modalTitle()),n(),p("disabled",i.loading()),n(2),c(" ",i.t("common.back")," "),n(5),c(" ",i.t("users.user_information")," "),n(2),p("formGroup",i.userForm),n(),u(i.error()?25:-1),n(2),u(i.isEditMode()?-1:27),n(3),c("",i.t("users.email")," "),n(3),f("is-invalid",i.isFieldInvalid("email")),p("placeholder",i.t("users.email")),n(),u(i.isFieldInvalid("email")?34:-1),n(3),v(i.t("users.phone")),n(),f("is-invalid",i.isFieldInvalid("phone")),p("placeholder",i.t("users.phone")),n(),u(i.isFieldInvalid("phone")?39:-1),n(),u(i.isEditMode()?-1:40),n(),u(i.isEditMode()?-1:41),n(3),c("",i.t("users.language")," "),n(3),f("is-invalid",i.isFieldInvalid("preferredLanguage")),n(5),u(i.isFieldInvalid("preferredLanguage")?52:-1),n(),u(i.isEditMode()?53:-1),n(4),c(" ",i.t("users.permissions")," "),n(3),c("",i.t("users.roles")," "),n(4),u(i.availableRoles().length>0?64:65),n(2),u(i.isFieldInvalid("roleIds")?66:-1),n(3),v(i.t("users.branches")),n(2),u(i.availableBranches().length>0?71:72),n(4),c(" ",i.t("users.branches_help")," "),n(2),p("disabled",i.loading()),n(2),c(" ",i.t("common.cancel")," "),n(),p("disabled",i.userForm.invalid||i.loading()),n(),u(i.loading()?81:-1),n(),u(i.isEditMode()?82:83))},dependencies:[k,Z,q,$,z,A,N,G,B,L,D,V,R,T],styles:[".modal.show[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_fadeIn .15s ease-out}@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0}to{opacity:1}}.modal-dialog[_ngcontent-%COMP%]{margin:2rem auto}.modal-content[_ngcontent-%COMP%]{border:none;box-shadow:0 .5rem 1rem #00000026;border-radius:.5rem}.modal-header[_ngcontent-%COMP%]{background-color:var(--bs-light);border-bottom:1px solid var(--bs-border-color);border-radius:.5rem .5rem 0 0}.modal-title[_ngcontent-%COMP%]{font-weight:600;color:var(--bs-dark)}.modal-body[_ngcontent-%COMP%]{padding:1.5rem}.modal-footer[_ngcontent-%COMP%]{background-color:var(--bs-light);border-top:1px solid var(--bs-border-color);border-radius:0 0 .5rem .5rem}.form-check[_ngcontent-%COMP%]{padding:.5rem;border:1px solid var(--bs-border-color);border-radius:.375rem;background-color:var(--bs-light);transition:all .2s ease}.form-check[_ngcontent-%COMP%]:hover{background-color:var(--bs-primary-bg-subtle);border-color:var(--bs-primary-border-subtle)}.form-check-input[_ngcontent-%COMP%]:checked + .form-check-label[_ngcontent-%COMP%]{font-weight:500;color:var(--bs-primary)}.form-switch[_ngcontent-%COMP%]   .form-check-input[_ngcontent-%COMP%]{width:2.5rem;height:1.25rem}.form-switch[_ngcontent-%COMP%]   .form-check-input[_ngcontent-%COMP%]:checked{background-color:var(--bs-success);border-color:var(--bs-success)}.alert[_ngcontent-%COMP%]{border:none;border-radius:.5rem;margin-bottom:1rem}.alert-danger[_ngcontent-%COMP%]{background-color:var(--bs-danger-bg-subtle);color:var(--bs-danger-text);border-left:4px solid var(--bs-danger)}.spinner-border-sm[_ngcontent-%COMP%]{width:1rem;height:1rem}.btn[_ngcontent-%COMP%]{border-radius:.375rem;padding:.5rem 1rem;font-weight:500}.btn-primary[_ngcontent-%COMP%]{background-color:var(--bs-primary);border-color:var(--bs-primary)}.btn-primary[_ngcontent-%COMP%]:hover{background-color:var(--bs-primary-hover, #0056b3);border-color:var(--bs-primary-hover, #0056b3)}.btn[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.is-invalid[_ngcontent-%COMP%]{border-color:var(--bs-danger);box-shadow:0 0 0 .2rem rgba(var(--bs-danger-rgb),.25)}.text-danger[_ngcontent-%COMP%]{color:var(--bs-danger)!important}[dir=rtl][_ngcontent-%COMP%]   .modal-dialog[_ngcontent-%COMP%]{margin:2rem auto}[dir=rtl][_ngcontent-%COMP%]   .form-check[_ngcontent-%COMP%]{text-align:right}[dir=rtl][_ngcontent-%COMP%]   .form-check-input[_ngcontent-%COMP%]{margin-left:0;margin-right:-1.5em}[dir=rtl][_ngcontent-%COMP%]   .form-check-label[_ngcontent-%COMP%]{padding-left:0;padding-right:1.5em}@media (max-width: 768px){.modal-dialog[_ngcontent-%COMP%]{margin:1rem;max-width:none}.modal-body[_ngcontent-%COMP%]{padding:1rem}.row.g-2[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{margin-bottom:.5rem}}.form-control[_ngcontent-%COMP%]:focus, .form-select[_ngcontent-%COMP%]:focus{border-color:var(--bs-primary);box-shadow:0 0 0 .2rem rgba(var(--bs-primary-rgb),.25)}.form-check-input[_ngcontent-%COMP%]:focus{box-shadow:0 0 0 .2rem rgba(var(--bs-primary-rgb),.25)}.form-text[_ngcontent-%COMP%]{font-size:.875rem;margin-top:.25rem}.form-check-input[type=checkbox][_ngcontent-%COMP%]{border-radius:.25rem}.form-check-input[type=checkbox][_ngcontent-%COMP%]:checked{background-color:var(--bs-primary);border-color:var(--bs-primary)}.spinner-border[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_spinner-border .75s linear infinite}@keyframes _ngcontent-%COMP%_spinner-border{to{transform:rotate(360deg)}}"]})};export{K as a};
