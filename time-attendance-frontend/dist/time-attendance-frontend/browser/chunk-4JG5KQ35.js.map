{
  "version": 3,
  "sources": ["src/app/pages/settings/leave-balances/leave-balance.service.ts"],
  "sourcesContent": ["import { Injectable, signal } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\nimport { Observable, map, tap, catchError, throwError } from 'rxjs';\r\nimport {\r\n  LeaveBalance,\r\n  LeaveBalanceSummary,\r\n  LeaveTransaction,\r\n  LeaveEntitlement,\r\n  SetLeaveEntitlementRequest,\r\n  ProcessMonthlyAccrualRequest,\r\n  AdjustLeaveBalanceRequest,\r\n  LeaveTransactionHistoryParams,\r\n  PagedResult\r\n} from '../../../shared/models/leave-balance.model';\r\nimport { NotificationService } from '../../../core/notifications/notification.service';\r\nimport { environment } from '../../../../environments/environment';\r\n\r\n/**\r\n * Service for managing leave balance and accrual operations.\r\n * Provides comprehensive leave management with balance tracking, entitlements, and transaction history.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class LeaveBalanceService {\r\n  private readonly apiUrl = `${environment.apiUrl}/api/v1/leave-balances`;\r\n\r\n  // Signal-based state management\r\n  private readonly _loading = signal<boolean>(false);\r\n  private readonly _error = signal<string | null>(null);\r\n  private readonly _currentBalance = signal<LeaveBalance | null>(null);\r\n  private readonly _balanceSummary = signal<LeaveBalanceSummary | null>(null);\r\n  private readonly _transactions = signal<LeaveTransaction[]>([]);\r\n  private readonly _transactionsPagedResult = signal<PagedResult<LeaveTransaction> | null>(null);\r\n\r\n  // Read-only signals for external consumption\r\n  readonly loading = this._loading.asReadonly();\r\n  readonly error = this._error.asReadonly();\r\n  readonly currentBalance = this._currentBalance.asReadonly();\r\n  readonly balanceSummary = this._balanceSummary.asReadonly();\r\n  readonly transactions = this._transactions.asReadonly();\r\n  readonly transactionsPagedResult = this._transactionsPagedResult.asReadonly();\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private notificationService: NotificationService\r\n  ) {}\r\n\r\n  /**\r\n   * Retrieves leave balance for a specific employee, vacation type, and year.\r\n   * GET /api/v1/leave-balances/employee/{employeeId}/vacation-type/{vacationTypeId}/year/{year}\r\n   */\r\n  getEmployeeLeaveBalance(\r\n    employeeId: number,\r\n    vacationTypeId: number,\r\n    year: number\r\n  ): Observable<LeaveBalance | null> {\r\n    this._loading.set(true);\r\n    this._error.set(null);\r\n\r\n    return this.http\r\n      .get<LeaveBalance | null>(`${this.apiUrl}/employee/${employeeId}/vacation-type/${vacationTypeId}/year/${year}`)\r\n      .pipe(\r\n        map(balance => balance ? this.transformBalanceDates(balance) : null),\r\n        tap(balance => {\r\n          this._currentBalance.set(balance);\r\n          this._loading.set(false);\r\n        }),\r\n        catchError(error => {\r\n          this._error.set(error.error?.message || 'Failed to load leave balance');\r\n          this._loading.set(false);\r\n          this.notificationService.error('Failed to load leave balance');\r\n          return throwError(() => error);\r\n        })\r\n      );\r\n  }\r\n\r\n  /**\r\n   * Retrieves complete balance summary for an employee across all vacation types.\r\n   * GET /api/v1/leave-balances/employee/{employeeId}/summary/{year}\r\n   */\r\n  getLeaveBalanceSummary(employeeId: number, year: number): Observable<LeaveBalanceSummary> {\r\n    this._loading.set(true);\r\n    this._error.set(null);\r\n\r\n    return this.http\r\n      .get<LeaveBalanceSummary>(`${this.apiUrl}/employee/${employeeId}/summary/${year}`)\r\n      .pipe(\r\n        map(summary => this.transformSummaryDates(summary)),\r\n        tap(summary => {\r\n          this._balanceSummary.set(summary);\r\n          this._loading.set(false);\r\n        }),\r\n        catchError(error => {\r\n          this._error.set(error.error?.message || 'Failed to load balance summary');\r\n          this._loading.set(false);\r\n          this.notificationService.error('Failed to load balance summary');\r\n          return throwError(() => error);\r\n        })\r\n      );\r\n  }\r\n\r\n  /**\r\n   * Retrieves paginated leave transaction history for an employee.\r\n   * GET /api/v1/leave-balances/employee/{employeeId}/transactions\r\n   */\r\n  getLeaveTransactionHistory(\r\n    params: LeaveTransactionHistoryParams\r\n  ): Observable<PagedResult<LeaveTransaction>> {\r\n    this._loading.set(true);\r\n    this._error.set(null);\r\n\r\n    let httpParams = new HttpParams();\r\n\r\n    if (params.vacationTypeId) {\r\n      httpParams = httpParams.set('vacationTypeId', params.vacationTypeId.toString());\r\n    }\r\n    if (params.year) {\r\n      httpParams = httpParams.set('year', params.year.toString());\r\n    }\r\n    if (params.pageNumber) {\r\n      httpParams = httpParams.set('pageNumber', params.pageNumber.toString());\r\n    }\r\n    if (params.pageSize) {\r\n      httpParams = httpParams.set('pageSize', params.pageSize.toString());\r\n    }\r\n\r\n    return this.http\r\n      .get<PagedResult<LeaveTransaction>>(\r\n        `${this.apiUrl}/employee/${params.employeeId}/transactions`,\r\n        { params: httpParams }\r\n      )\r\n      .pipe(\r\n        map(result => ({\r\n          ...result,\r\n          items: result.items.map(transaction => this.transformTransactionDates(transaction))\r\n        })),\r\n        tap(result => {\r\n          this._transactions.set(result.items);\r\n          this._transactionsPagedResult.set(result);\r\n          this._loading.set(false);\r\n        }),\r\n        catchError(error => {\r\n          this._error.set(error.error?.message || 'Failed to load transaction history');\r\n          this._loading.set(false);\r\n          this.notificationService.error('Failed to load transaction history');\r\n          return throwError(() => error);\r\n        })\r\n      );\r\n  }\r\n\r\n  /**\r\n   * Sets or updates leave entitlement for an employee.\r\n   * POST /api/v1/leave-balances/entitlements\r\n   * Requires: LeaveEntitlementManagement policy\r\n   */\r\n  setLeaveEntitlement(request: SetLeaveEntitlementRequest): Observable<number> {\r\n    this._loading.set(true);\r\n    this._error.set(null);\r\n\r\n    return this.http.post<number>(`${this.apiUrl}/entitlements`, request).pipe(\r\n      tap(entitlementId => {\r\n        this._loading.set(false);\r\n        this.notificationService.success('Leave entitlement set successfully');\r\n      }),\r\n      catchError(error => {\r\n        this._loading.set(false);\r\n        const errorMessage = error.error?.message || 'Failed to set leave entitlement';\r\n        this._error.set(errorMessage);\r\n        this.notificationService.error(errorMessage);\r\n        return throwError(() => error);\r\n      })\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Processes monthly leave accrual for employees.\r\n   * POST /api/v1/leave-balances/accrual/process-monthly\r\n   * Requires: LeaveAccrualManagement policy\r\n   */\r\n  processMonthlyAccrual(request: ProcessMonthlyAccrualRequest): Observable<number> {\r\n    this._loading.set(true);\r\n    this._error.set(null);\r\n\r\n    return this.http.post<number>(`${this.apiUrl}/accrual/process-monthly`, request).pipe(\r\n      tap(employeesProcessed => {\r\n        this._loading.set(false);\r\n        this.notificationService.success(\r\n          `Monthly accrual processed successfully for ${employeesProcessed} employee(s)`\r\n        );\r\n      }),\r\n      catchError(error => {\r\n        this._loading.set(false);\r\n        const errorMessage = error.error?.message || 'Failed to process monthly accrual';\r\n        this._error.set(errorMessage);\r\n        this.notificationService.error(errorMessage);\r\n        return throwError(() => error);\r\n      })\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Manually adjusts leave balance for an employee.\r\n   * POST /api/v1/leave-balances/adjustments\r\n   * Requires: LeaveBalanceAdjustment policy\r\n   */\r\n  adjustLeaveBalance(request: AdjustLeaveBalanceRequest): Observable<boolean> {\r\n    this._loading.set(true);\r\n    this._error.set(null);\r\n\r\n    return this.http.post<boolean>(`${this.apiUrl}/adjustments`, request).pipe(\r\n      tap(() => {\r\n        this._loading.set(false);\r\n        this.notificationService.success('Leave balance adjusted successfully');\r\n        // Refresh balance summary if available\r\n        const summary = this._balanceSummary();\r\n        if (summary && summary.employeeId === request.employeeId) {\r\n          this.getLeaveBalanceSummary(request.employeeId, request.year).subscribe();\r\n        }\r\n      }),\r\n      catchError(error => {\r\n        this._loading.set(false);\r\n        const errorMessage = error.error?.message || 'Failed to adjust leave balance';\r\n        this._error.set(errorMessage);\r\n        this.notificationService.error(errorMessage);\r\n        return throwError(() => error);\r\n      })\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Gets current year for balance queries.\r\n   */\r\n  getCurrentYear(): number {\r\n    return new Date().getFullYear();\r\n  }\r\n\r\n  /**\r\n   * Clears all cached balance data.\r\n   */\r\n  clearBalanceData(): void {\r\n    this._currentBalance.set(null);\r\n    this._balanceSummary.set(null);\r\n    this._transactions.set([]);\r\n    this._transactionsPagedResult.set(null);\r\n    this._error.set(null);\r\n  }\r\n\r\n  /**\r\n   * Refreshes the current balance summary without changing parameters.\r\n   */\r\n  refreshBalanceSummary(): void {\r\n    const summary = this._balanceSummary();\r\n    if (summary) {\r\n      this.getLeaveBalanceSummary(summary.employeeId, summary.year).subscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Transforms date strings to Date objects in balance data.\r\n   */\r\n  private transformBalanceDates(balance: LeaveBalance): LeaveBalance {\r\n    return {\r\n      ...balance,\r\n      effectiveStartDate: balance.effectiveStartDate || null,\r\n      effectiveEndDate: balance.effectiveEndDate || null,\r\n      lastAccrualDate: balance.lastAccrualDate || null\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Transforms date strings to Date objects in balance summary.\r\n   */\r\n  private transformSummaryDates(summary: LeaveBalanceSummary): LeaveBalanceSummary {\r\n    return {\r\n      ...summary,\r\n      vacationTypeBalances: summary.vacationTypeBalances.map(vtb => ({\r\n        ...vtb,\r\n        lastAccrualDate: vtb.lastAccrualDate || null\r\n      }))\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Transforms date strings to Date objects in transaction data.\r\n   */\r\n  private transformTransactionDates(transaction: LeaveTransaction): LeaveTransaction {\r\n    return {\r\n      ...transaction,\r\n      transactionDate: transaction.transactionDate\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Navigates to a specific page in transaction history.\r\n   */\r\n  goToTransactionPage(employeeId: number, page: number): void {\r\n    const currentResult = this._transactionsPagedResult();\r\n    if (currentResult && page >= 1 && page <= currentResult.totalPages) {\r\n      const currentParams: LeaveTransactionHistoryParams = {\r\n        employeeId,\r\n        pageNumber: page,\r\n        pageSize: currentResult.pageSize\r\n      };\r\n      this.getLeaveTransactionHistory(currentParams).subscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Changes page size for transaction history.\r\n   */\r\n  changeTransactionPageSize(employeeId: number, newPageSize: number): void {\r\n    const params: LeaveTransactionHistoryParams = {\r\n      employeeId,\r\n      pageNumber: 1,\r\n      pageSize: newPageSize\r\n    };\r\n    this.getLeaveTransactionHistory(params).subscribe();\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
