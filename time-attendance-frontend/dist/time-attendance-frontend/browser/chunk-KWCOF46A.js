import{a as _}from"./chunk-HHXRLUSQ.js";import{a as h}from"./chunk-RCBJJ7UY.js";import{Bc as v,Cc as S,J as g,M as V,Q as b,da as p,k as r,n as d,x as n}from"./chunk-JSQL33QG.js";import{a as c,b as l}from"./chunk-DGAILPFQ.js";var D=class f{constructor(e,t){this.http=e;this.notificationService=t}apiUrl=`${h.apiUrl}/api/v1/employee-vacations`;_vacations=p([]);_loading=p(!1);_error=p(null);_pagedResult=p(null);vacations=this._vacations.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();pagedResult=this._pagedResult.asReadonly();totalPages=p(()=>{let e=this._pagedResult();return!e||e.pageSize===0?1:Math.ceil(e.totalCount/e.pageSize)});hasNextPage=p(()=>{let e=this._pagedResult();return e?e.page<this.totalPages()():!1});hasPreviousPage=p(()=>{let e=this._pagedResult();return e?e.page>1:!1});getVacations(e){this._loading.set(!0),this._error.set(null);let t=new v;return e&&(e.employeeId&&(t=t.set("employeeId",e.employeeId.toString())),e.vacationTypeId&&(t=t.set("vacationTypeId",e.vacationTypeId.toString())),e.startDate&&(t=t.set("startDate",e.startDate.toISOString())),e.endDate&&(t=t.set("endDate",e.endDate.toISOString())),e.isApproved!==void 0&&(t=t.set("isApproved",e.isApproved.toString())),e.isCurrentlyActive!==void 0&&(t=t.set("isCurrentlyActive",e.isCurrentlyActive.toString())),e.isUpcoming!==void 0&&(t=t.set("isUpcoming",e.isUpcoming.toString())),e.searchTerm&&(t=t.set("searchTerm",e.searchTerm)),e.page&&(t=t.set("page",e.page.toString())),e.pageSize&&(t=t.set("pageSize",e.pageSize.toString())),e.sortBy&&(t=t.set("sortBy",e.sortBy)),e.sortDescending&&(t=t.set("sortDescending",e.sortDescending.toString()))),this.http.get(this.apiUrl,{params:t}).pipe(d(i=>l(c({},i),{items:i.items.map(a=>this.transformDates(a))})),g(i=>{this._vacations.set(i.items),this._pagedResult.set(i),this._loading.set(!1)}),n(i=>(this._error.set(i.error?.message||"Failed to load vacations"),this._loading.set(!1),this.notificationService.error("Failed to load employee vacations"),r(()=>i))))}getVacationById(e){return this.http.get(`${this.apiUrl}/${e}`).pipe(d(t=>this.transformDates(t)),n(t=>(this.notificationService.error("Failed to load vacation details"),r(()=>t))))}createVacation(e){return this._loading.set(!0),this.http.post(this.apiUrl,e).pipe(g(t=>{this._loading.set(!1),this.notificationService.success("Vacation created successfully"),this.refreshVacations()}),n(t=>{this._loading.set(!1);let i=t.error?.message||"Failed to create vacation";return this._error.set(i),this.notificationService.error(i),r(()=>t)}))}updateVacation(e,t){return this._loading.set(!0),this.http.put(`${this.apiUrl}/${e}`,t).pipe(g(()=>{this._loading.set(!1),this.notificationService.success("Vacation updated successfully"),this.refreshVacations()}),n(i=>{this._loading.set(!1);let a=i.error?.message||"Failed to update vacation";return this._error.set(a),this.notificationService.error(a),r(()=>i)}))}deleteVacation(e){return this._loading.set(!0),this.http.delete(`${this.apiUrl}/${e}`).pipe(g(()=>{this._loading.set(!1),this.notificationService.success("Vacation deleted successfully");let t=this._vacations();this._vacations.set(t.filter(a=>a.id!==e));let i=this._pagedResult();i&&this._pagedResult.set(l(c({},i),{totalCount:i.totalCount-1}))}),n(t=>{this._loading.set(!1);let i=t.error?.message||"Failed to delete vacation";return this._error.set(i),this.notificationService.error(i),r(()=>t)}))}toggleVacationStatus(e){return this.http.patch(`${this.apiUrl}/${e}/toggle-status`,{}).pipe(g(()=>{this.notificationService.success("Vacation status updated successfully");let i=this._vacations().map(a=>a.id===e?l(c({},a),{isApproved:!a.isApproved}):a);this._vacations.set(i)}),n(t=>{let i=t.error?.message||"Failed to update vacation status";return this.notificationService.error(i),r(()=>t)}))}getVacationCalendar(e,t,i){let a=new v().set("startDate",e.toISOString()).set("endDate",t.toISOString());return i&&i.length>0&&i.forEach(s=>{a=a.append("employeeIds",s.toString())}),this.http.get(`${this.apiUrl}/calendar`,{params:a}).pipe(d(s=>s.map(o=>l(c({},o),{startDate:new Date(o.startDate),endDate:new Date(o.endDate)}))),n(s=>(this.notificationService.error("Failed to load vacation calendar"),r(()=>s))))}checkVacationConflicts(e,t,i,a){return this.getVacations({employeeId:e}).pipe(d(s=>{let o=s.items.filter(m=>a&&m.id===a?!1:m.startDate<=i&&m.endDate>=t);return{hasConflict:o.length>0,conflictingVacations:o,message:o.length>0?`Found ${o.length} overlapping vacation(s)`:"No conflicts found"}}))}refreshVacations(){let e=this._pagedResult();e?this.getVacations({page:e.page,pageSize:e.pageSize}).subscribe():this.getVacations().subscribe()}clearVacations(){this._vacations.set([]),this._pagedResult.set(null),this._error.set(null)}transformDates(e){return l(c({},e),{startDate:new Date(e.startDate),endDate:new Date(e.endDate),createdAtUtc:new Date(e.createdAtUtc),modifiedAtUtc:e.modifiedAtUtc?new Date(e.modifiedAtUtc):void 0})}applyFilters(e){let t=this._pagedResult();this.getVacations(l(c({},e),{page:1,pageSize:t?.pageSize||20})).subscribe()}changePageSize(e){this.getVacations({page:1,pageSize:e}).subscribe()}goToPage(e){if(e>=1&&e<=this.totalPages()()){let t=this._pagedResult();this.getVacations({page:e,pageSize:t?.pageSize||20}).subscribe()}}getVacationStatistics(e){return this.getVacations(l(c({},e),{pageSize:1e3})).pipe(d(t=>{let i=t.items,a=i.length,s=i.filter(u=>u.isApproved).length,o=i.filter(u=>u.isCurrentlyActive).length,m=i.filter(u=>u.isUpcoming).length,y=i.reduce((u,R)=>u+R.totalDays,0);return{totalVacations:a,approvedVacations:s,pendingVacations:a-s,activeVacations:o,upcomingVacations:m,totalDays:y,averageDaysPerVacation:a>0?Math.round(y/a*10)/10:0}}))}getEmployees(){return this.http.get(`${h.apiUrl}/api/v1/employees/dropdown`).pipe(n(e=>(this.notificationService.error("Failed to load employees"),r(()=>e))))}getVacationTypes(){return this.http.get(`${h.apiUrl}/api/v1/vacation-types/dropdown`).pipe(n(e=>(this.notificationService.error("Failed to load vacation types"),r(()=>e))))}getBranches(){return this.http.get(`${h.apiUrl}/api/v1/branches/dropdown`).pipe(n(e=>(this.notificationService.error("Failed to load branches"),r(()=>e))))}getDepartments(){return this.http.get(`${h.apiUrl}/api/v1/departments/dropdown`).pipe(n(e=>(this.notificationService.error("Failed to load departments"),r(()=>e))))}getEmployeeCountPreview(e){let t=new v().set("assignmentType",e.assignmentType.toString());return e.branchId&&(t=t.set("branchId",e.branchId.toString())),e.departmentId&&(t=t.set("departmentId",e.departmentId.toString())),this.http.get(`${h.apiUrl}/api/v1/employees/count-preview`,{params:t}).pipe(d(i=>i.count),n(i=>(this.notificationService.error("Failed to load employee count preview"),r(()=>i))))}createBulkVacations(e){return this._loading.set(!0),this.http.post(`${this.apiUrl}/bulk`,e).pipe(d(t=>t.value),g(()=>{this._loading.set(!1),this.refreshVacations()}),n(t=>{this._loading.set(!1);let i=t.error?.message||"Failed to create bulk vacations";return this.notificationService.error(i),r(()=>t)}))}static \u0275fac=function(t){return new(t||f)(b(S),b(_))};static \u0275prov=V({token:f,factory:f.\u0275fac,providedIn:"root"})};export{D as a};
