<div class="dashboard-container">
  <!-- Page Header -->
  <app-page-header
    [title]="t('dashboard.title')">
  </app-page-header>

  <!-- Dashboard Controls -->
  <div class="dashboard-controls mb-4">
    <div class="d-flex justify-content-between align-items-start">
      <div class="welcome-section">
        <p class="dashboard-subtitle mb-0">{{ t('dashboard.welcome', { username: currentUser()?.username || 'User' }) }}</p>
        @if (lastRefresh()) {
          <small class="text-muted">
            <i class="fa-solid fa-clock me-1"></i>
            {{ t('dashboard.last_refresh') }}: {{ getTimeSinceLastRefresh() }}
          </small>
        }
      </div>

      <div class="controls-section">
        <!-- Refresh Controls -->
        <div class="d-flex align-items-center gap-3">
          <button
            class="btn btn-outline-primary btn-sm"
            (click)="refreshData()"
            [disabled]="loading()">
            <i class="fa-solid fa-refresh" [class.fa-spin]="loading()"></i>
            {{ t('dashboard.refresh') }}
          </button>

          <div class="form-check form-switch">
            <input
              class="form-check-input"
              type="checkbox"
              id="autoRefreshToggle"
              [checked]="autoRefresh()"
              (change)="toggleAutoRefresh()">
            <label class="form-check-label" for="autoRefreshToggle">
              {{ t('dashboard.auto_refresh') }}
            </label>
          </div>

          <!-- Filters -->
          <div class="d-flex gap-2">
            @if (availableBranches().length > 1) {
              <select
                class="form-select form-select-sm"
                [value]="filters().branchId || ''"
                (change)="updateFilters({ branchId: $any($event.target).value ? +$any($event.target).value : undefined })">
                <option value="">{{ t('dashboard.all_branches') }}</option>
                @for (branch of availableBranches(); track branch.id) {
                  <option [value]="branch.id">{{ branch.name }}</option>
                }
              </select>
            }

            @if (availableDepartments().length > 1) {
              <select
                class="form-select form-select-sm"
                [value]="filters().departmentId || ''"
                (change)="updateFilters({ departmentId: $any($event.target).value ? +$any($event.target).value : undefined })">
                <option value="">{{ t('dashboard.all_departments') }}</option>
                @for (dept of availableDepartments(); track dept.id) {
                  <option [value]="dept.id">{{ dept.name }}</option>
                }
              </select>
            }
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-overlay">
      <div class="loading-content">
        <app-loading-spinner
          [message]="t('dashboard.loading_comprehensive')"
          [variant]="'primary'"
          [centered]="true">
        </app-loading-spinner>
      </div>
    </div>
  }

  <!-- Error State -->
  @if (error() && !loading()) {
    <div class="alert alert-danger" role="alert">
      <i class="fa-solid fa-exclamation-triangle me-2"></i>
      {{ error() }}
      <button class="btn btn-sm btn-outline-danger ms-2" (click)="refreshData()">
        {{ t('common.retry') }}
      </button>
    </div>
  }

  <!-- Dashboard Content -->
  @if (!loading() && !error()) {
    <!-- Key Metrics Cards -->
    <div class="metrics-section">
      <h2 class="section-title">{{ t('dashboard.key_metrics') }}</h2>
      <app-stats-grid
        [stats]="dashboardStats()"
        [columns]="4"
        [loading]="loading()">
      </app-stats-grid>
    </div>

    <!-- Widget Sections -->
    <div class="widgets-section">
      <div class="widgets-grid">

        <!-- Attendance Widget -->
        @if (showAttendanceWidget() && dashboardData()?.attendance) {
          <div class="widget attendance-widget">
            <div class="widget-header">
              <h3><i class="fa-solid fa-calendar-check me-2"></i>{{ t('dashboard.attendance_overview') }}</h3>
            </div>
            <div class="widget-content">
              <div class="attendance-stats">
                <div class="stat-item">
                  <span class="stat-label">{{ t('dashboard.present_today') }}</span>
                  <span class="stat-value text-success">{{ dashboardData()?.attendance.todayPresent || 0 }}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">{{ t('dashboard.absent_today') }}</span>
                  <span class="stat-value text-danger">{{ dashboardData()?.attendance.todayAbsent || 0 }}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">{{ t('dashboard.late_today') }}</span>
                  <span class="stat-value text-warning">{{ dashboardData()?.attendance.todayLate || 0 }}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">{{ t('dashboard.attendance_rate') }}</span>
                  <span class="stat-value text-primary">{{ (dashboardData()?.attendance.attendanceRate || 0) | number:'1.1-1' }}%</span>
                </div>
              </div>

              @if (dashboardData()?.attendance?.incompleteRecords?.length) {
                <div class="incomplete-records mt-3">
                  <h5>{{ t('dashboard.incomplete_records') }}</h5>
                  <div class="records-list">
                    @for (record of dashboardData()?.attendance?.incompleteRecords?.slice(0, 5) || []; track record.employeeId) {
                      <div class="record-item">
                        <span class="employee-name">{{ record.employeeName }}</span>
                        <span class="employee-status badge bg-warning">{{ record.status }}</span>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        }

        <!-- Human Resources Widget -->
        @if (showHumanResourcesWidget() && dashboardData()?.humanResources) {
          <div class="widget hr-widget">
            <div class="widget-header">
              <h3><i class="fa-solid fa-users me-2"></i>{{ t('dashboard.human_resources') }}</h3>
            </div>
            <div class="widget-content">
              <div class="hr-stats">
                <div class="stat-row">
                  <span class="stat-label">{{ t('dashboard.total_employees') }}</span>
                  <span class="stat-value">{{ dashboardData()?.humanResources.totalEmployees || 0 }}</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">{{ t('dashboard.active_employees') }}</span>
                  <span class="stat-value text-success">{{ dashboardData()?.humanResources.activeEmployees || 0 }}</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">{{ t('dashboard.total_users') }}</span>
                  <span class="stat-value">{{ dashboardData()?.humanResources.totalUsers || 0 }}</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">{{ t('dashboard.active_users') }}</span>
                  <span class="stat-value text-success">{{ dashboardData()?.humanResources.activeUsers || 0 }}</span>
                </div>
              </div>

              @if (dashboardData()?.humanResources?.roleDistribution?.length) {
                <div class="role-distribution mt-3">
                  <h5>{{ t('dashboard.role_distribution') }}</h5>
                  @for (role of dashboardData()?.humanResources?.roleDistribution?.slice(0, 4) || []; track role.roleName) {
                    <div class="role-item">
                      <span class="role-name">{{ role.roleName }}</span>
                      <span class="role-count">{{ role.userCount }}</span>
                      <span class="role-percentage">({{ role.percentage | number:'1.0-0' }}%)</span>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }

        <!-- Vacation/Leave Widget -->
        @if (showVacationWidget() && dashboardData()?.leaves) {
          <div class="widget vacation-widget">
            <div class="widget-header">
              <h3><i class="fa-solid fa-calendar-times me-2"></i>{{ t('dashboard.leave_management') }}</h3>
            </div>
            <div class="widget-content">
              <div class="vacation-stats">
                <div class="stat-item">
                  <span class="stat-label">{{ t('dashboard.pending_requests') }}</span>
                  <span class="stat-value text-warning">{{ dashboardData()?.leaves.pendingRequests || 0 }}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">{{ t('dashboard.on_leave_today') }}</span>
                  <span class="stat-value text-info">{{ dashboardData()?.leaves.onLeaveToday || 0 }}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">{{ t('dashboard.approved_today') }}</span>
                  <span class="stat-value text-success">{{ dashboardData()?.leaves.approvedToday || 0 }}</span>
                </div>
              </div>

              @if (dashboardData()?.leaves?.upcomingVacations?.length) {
                <div class="upcoming-vacations mt-3">
                  <h5>{{ t('dashboard.upcoming_vacations') }}</h5>
                  @for (vacation of dashboardData()?.leaves?.upcomingVacations?.slice(0, 3) || []; track vacation.vacationId) {
                    <div class="vacation-item">
                      <span class="employee-name">{{ vacation.employeeName }}</span>
                      <span class="vacation-type">{{ vacation.vacationType }}</span>
                      <span class="vacation-dates">{{ vacation.startDate | date:'shortDate' }} - {{ vacation.endDate | date:'shortDate' }}</span>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }

        <!-- Organization Widget -->
        @if (showOrganizationWidget() && dashboardData()?.organization) {
          <div class="widget organization-widget">
            <div class="widget-header">
              <h3><i class="fa-solid fa-sitemap me-2"></i>{{ t('dashboard.organization_structure') }}</h3>
            </div>
            <div class="widget-content">
              <div class="org-stats">
                <div class="stat-row">
                  <span class="stat-label">{{ t('dashboard.total_branches') }}</span>
                  <span class="stat-value">{{ dashboardData()?.organization.totalBranches || 0 }}</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">{{ t('dashboard.active_branches') }}</span>
                  <span class="stat-value text-success">{{ dashboardData()?.organization.activeBranches || 0 }}</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">{{ t('dashboard.total_departments') }}</span>
                  <span class="stat-value">{{ dashboardData()?.organization.totalDepartments || 0 }}</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">{{ t('dashboard.active_departments') }}</span>
                  <span class="stat-value text-success">{{ dashboardData()?.organization.activeDepartments || 0 }}</span>
                </div>
              </div>
            </div>
          </div>
        }

        <!-- Shift Management Widget -->
        @if (showShiftWidget() && dashboardData()?.shifts) {
          <div class="widget shift-widget">
            <div class="widget-header">
              <h3><i class="fa-solid fa-clock me-2"></i>{{ t('dashboard.shift_management') }}</h3>
            </div>
            <div class="widget-content">
              <div class="shift-stats">
                <div class="stat-item">
                  <span class="stat-label">{{ t('dashboard.active_shifts') }}</span>
                  <span class="stat-value">{{ dashboardData()?.shifts.activeShifts || 0 }}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">{{ t('dashboard.total_assignments') }}</span>
                  <span class="stat-value">{{ dashboardData()?.shifts.totalShiftAssignments || 0 }}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">{{ t('dashboard.today_coverage') }}</span>
                  <span class="stat-value text-success">{{ dashboardData()?.shifts.todayCoverage || 0 }}</span>
                </div>
              </div>
            </div>
          </div>
        }

        <!-- System Health Widget -->
        @if (showSystemWidget() && dashboardData()?.system) {
          <div class="widget system-widget">
            <div class="widget-header">
              <h3><i class="fa-solid fa-server me-2"></i>{{ t('dashboard.system_health') }}</h3>
            </div>
            <div class="widget-content">
              <div class="system-stats">
                <div class="stat-row">
                  <span class="stat-label">{{ t('dashboard.active_sessions') }}</span>
                  <span class="stat-value text-success">{{ dashboardData()?.system.activeSessions || 0 }}</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">{{ t('dashboard.today_logins') }}</span>
                  <span class="stat-value">{{ dashboardData()?.system.todayLogins || 0 }}</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">{{ t('dashboard.system_uptime') }}</span>
                  <span class="stat-value text-info">{{ dashboardData()?.system.systemUptime || 'N/A' }}</span>
                </div>
              </div>

              @if (dashboardData()?.system?.recentActivities?.length) {
                <div class="recent-activities mt-3">
                  <h5>{{ t('dashboard.recent_activities') }}</h5>
                  @for (activity of dashboardData()?.system?.recentActivities?.slice(0, 3) || []; track activity.id) {
                    <div class="activity-item">
                      <span class="activity-description">{{ activity.description }}</span>
                      <span class="activity-time">{{ activity.timestamp | date:'short' }}</span>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }

      </div>
    </div>

    <!-- Auto-refresh settings -->
    @if (autoRefresh()) {
      <div class="auto-refresh-settings">
        <div class="settings-card">
          <label for="refreshInterval" class="form-label">{{ t('dashboard.refresh_interval') }}</label>
          <select
            id="refreshInterval"
            class="form-select form-select-sm"
            [value]="dashboardService.refreshInterval()"
            (change)="updateRefreshInterval(+($any($event.target).value))">
            @for (interval of refreshIntervals; track interval.value) {
              <option [value]="interval.value">{{ interval.label }}</option>
            }
          </select>
        </div>
      </div>
    }
  }