<!-- Loading State -->
@if (loading()) {
  <div class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">{{ i18n.t('common.loading') }}</span>
    </div>
  </div>
}

<!-- Error State -->
@if (error()) {
  <div class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ error() }}
  </div>
}

<!-- Main Content -->
@if (!loading() && !error() && employee() && attendanceRecord()) {
  <div class="container-fluid">
    <!-- Page Header -->
    <app-page-header
      [title]="i18n.t('attendance.daily_detail.title')">
    </app-page-header>

    <!-- Navigation and Controls -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item">
            <a routerLink="/attendance">{{ i18n.t('attendance.title') }}</a>
          </li>
          <li class="breadcrumb-item">
            <a routerLink="/attendance/daily">{{ i18n.t('attendance.daily_view') }}</a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            {{ i18n.t('attendance.daily_detail.title') }}
          </li>
        </ol>
      </nav>

      <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-primary" (click)="onRefresh()">
          <i class="fas fa-sync-alt me-2"></i>
          {{ i18n.t('common.refresh') }}
        </button>
        <button type="button" class="btn btn-primary" (click)="onEdit()">
          <i class="fas fa-edit me-2"></i>
          {{ i18n.t('attendance.actions.edit') }}
        </button>
        <button type="button" class="btn btn-outline-secondary" (click)="onBack()">
          <i class="fas fa-arrow-left me-2"></i>
          {{ i18n.t('common.back') }}
        </button>
      </div>
    </div>

    <!-- Employee Information Card -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-user me-2"></i>
              {{ i18n.t('attendance.daily_detail.employee_info') }}
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <strong>{{ i18n.t('employees.fields.employee_number') }}:</strong>
                <br>
                <span class="text-muted">{{ employee()?.employeeNumber }}</span>
              </div>
              <div class="col-md-3">
                <strong>{{ i18n.t('employees.fields.full_name') }}:</strong>
                <br>
                <span class="text-primary fw-bold">{{ employee()?.fullName }}</span>
              </div>
              <div class="col-md-3">
                <strong>{{ i18n.t('employees.fields.department') }}:</strong>
                <br>
                <span class="text-muted">{{ employee()?.departmentName || '--' }}</span>
              </div>
              <div class="col-md-3">
                <strong>{{ i18n.t('attendance.fields.attendance_date') }}:</strong>
                <br>
                <span class="text-info fw-bold">{{ attendanceDate | date: 'fullDate' }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Attendance Status Overview -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-chart-line me-2"></i>
              {{ i18n.t('attendance.daily_detail.attendance_overview') }}
            </h5>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-2">
                <div class="border rounded p-3">
                  <h6 class="text-muted small mb-1">{{ i18n.t('attendance.fields.status') }}</h6>
                  <app-status-badge
                    [status]="statusBadge().label"
                    [variant]="statusBadge().variant"
                    class="fs-6">
                  </app-status-badge>
                </div>
              </div>
              <div class="col-md-2">
                <div class="border rounded p-3">
                  <h6 class="text-muted small mb-1">{{ i18n.t('attendance.fields.working_hours') }}</h6>
                  <div class="fw-bold text-primary">{{ formatHoursAsTime(attendanceRecord()!.workingHours || 0) }}</div>
                </div>
              </div>
              <div class="col-md-2">
                <div class="border rounded p-3">
                  <h6 class="text-muted small mb-1">{{ i18n.t('attendance.fields.overtime_hours') }}</h6>
                  <div class="fw-bold text-success">{{ formatHoursAsTime(attendanceRecord()!.overtimeHours || 0) }}</div>
                </div>
              </div>
              <div class="col-md-2">
                <div class="border rounded p-3">
                  <h6 class="text-muted small mb-1">{{ i18n.t('attendance.fields.late_minutes') }}</h6>
                  <div class="fw-bold text-warning">{{ attendanceRecord()!.lateMinutes || 0 }} {{ i18n.t('common.minutes') }}</div>
                </div>
              </div>
              <div class="col-md-2">
                <div class="border rounded p-3">
                  <h6 class="text-muted small mb-1">{{ i18n.t('attendance.fields.early_leave_minutes') }}</h6>
                  <div class="fw-bold text-info">{{ attendanceRecord()!.earlyLeaveMinutes || 0 }} {{ i18n.t('common.minutes') }}</div>
                </div>
              </div>
              <div class="col-md-2">
                <div class="border rounded p-3">
                  <h6 class="text-muted small mb-1">{{ i18n.t('attendance.fields.total_late') }}</h6>
                  <div class="fw-bold text-danger">{{ getTotalLateMinutes() }} {{ i18n.t('common.minutes') }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Time Details -->
    <div class="row mb-4">
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-clock me-2"></i>
              {{ i18n.t('attendance.daily_detail.time_details') }}
            </h5>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-6">
                <strong>{{ i18n.t('attendance.fields.check_in_time') }}:</strong>
                <br>
                <span [class]="attendanceRecord()!.actualCheckInTime ? 'text-success fw-bold' : 'text-muted'">
                  {{ formatTime(attendanceRecord()!.actualCheckInTime) }}
                </span>
              </div>
              <div class="col-6">
                <strong>{{ i18n.t('attendance.fields.check_out_time') }}:</strong>
                <br>
                <span [class]="attendanceRecord()!.actualCheckOutTime ? 'text-info fw-bold' : 'text-muted'">
                  {{ formatTime(attendanceRecord()!.actualCheckOutTime) }}
                </span>
              </div>
            </div>
            @if (attendanceRecord()!.breakHours) {
              <div class="row">
                <div class="col-12">
                  <strong>{{ i18n.t('attendance.fields.break_hours') }}:</strong>
                  <br>
                  <span class="text-warning fw-bold">{{ formatHoursAsTime(attendanceRecord()!.breakHours || 0) }}</span>
                </div>
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Shift Information -->
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-calendar-clock me-2"></i>
              {{ i18n.t('attendance.daily_detail.shift_info') }}
            </h5>
          </div>
          <div class="card-body">
            @if (shift(); as shiftData) {
              <div>
                <div class="row mb-3">
                  <div class="col-6">
                    <strong>{{ i18n.t('shifts.fields.name') }}:</strong>
                    <br>
                    <span class="text-primary fw-bold">{{ shiftData.name }}</span>
                  </div>
                  <div class="col-6">
                    <strong>{{ i18n.t('shifts.fields.description') }}:</strong>
                    <br>
                    <span class="text-muted">{{ shiftData.description || '--' }}</span>
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-6">
                    <strong>{{ i18n.t('shifts.fields.start_time') }}:</strong>
                    <br>
                    <span class="text-success">{{ getShiftStartTime(shiftData) }}</span>
                  </div>
                  <div class="col-6">
                    <strong>{{ i18n.t('shifts.fields.end_time') }}:</strong>
                    <br>
                    <span class="text-info">{{ getShiftEndTime(shiftData) }}</span>
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-6">
                    <strong>{{ i18n.t('shifts.fields.working_hours') }}:</strong>
                    <br>
                    <span class="text-primary fw-bold">{{ formatHoursAsTime(shiftData.requiredHours || 0) }}</span>
                  </div>
                  <div class="col-6">
                    <strong>{{ i18n.t('shifts.fields.shift_type') }}:</strong>
                    <br>
                    <span class="text-warning">{{ getShiftTypeDisplay(shiftData) }}</span>
                  </div>
                </div>
                @if (shiftData.allowFlexibleHours) {
                  <div class="row">
                    <div class="col-12">
                      <div class="alert alert-info">
                        <strong>{{ i18n.t('shifts.fields.flexible_hours') }}:</strong>
                        <ul class="mb-0 mt-2">
                          <li>{{ i18n.t('shifts.fields.flex_minutes_before') }}: {{ shiftData.flexMinutesBefore || 0 }} {{ i18n.t('common.minutes') }}</li>
                          <li>{{ i18n.t('shifts.fields.flex_minutes_after') }}: {{ shiftData.flexMinutesAfter || 0 }} {{ i18n.t('common.minutes') }}</li>
                          <li>{{ i18n.t('shifts.fields.grace_period') }}: {{ shiftData.gracePeriodMinutes || 0 }} {{ i18n.t('common.minutes') }}</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="text-center text-muted py-3">
                <i class="fas fa-info-circle fa-2x mb-2"></i>
                <p>{{ i18n.t('attendance.daily_detail.no_shift_assigned') }}</p>
              </div>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Leave & Excuse Details -->
    @if (hasLeaveExcuseData()) {
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-calendar-times me-2"></i>
                {{ i18n.t('attendance.daily_detail.leave_excuse_details') }}
              </h5>
            </div>
            <div class="card-body">
              <!-- Employee Vacations -->
              @if (leaveExcuseDetails()?.vacations && leaveExcuseDetails()!.vacations.length > 0) {
                <div class="mb-4">
                  <h6 class="section-header vacation-header">
                    <i class="fas fa-plane me-2"></i>
                    {{ i18n.t('attendance.daily_detail.vacations') }}
                  </h6>
                  @for (vacation of leaveExcuseDetails()!.vacations; track vacation.id) {
                    <div class="card leave-excuse-card vacation-card border-start border-primary border-3 mb-3">
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-3">
                            <strong>{{ i18n.t('vacation_types.fields.name') }}:</strong>
                            <br>
                            <span class="text-primary fw-bold">{{ vacation.vacationTypeName }}</span>
                          </div>
                          <div class="col-md-3">
                            <strong>{{ i18n.t('employee_vacations.fields.period') }}:</strong>
                            <br>
                            <span class="text-muted">
                              {{ formatDate(vacation.startDate) }} - {{ formatDate(vacation.endDate) }}
                            </span>
                          </div>
                          <div class="col-md-2">
                            <strong>{{ i18n.t('employee_vacations.fields.duration') }}:</strong>
                            <br>
                            <span class="text-info fw-bold">{{ vacation.durationDays }} {{ vacation.durationDays === 1 ? i18n.t('common.dayUnit') : i18n.t('common.days_text') }}</span>
                          </div>
                          <div class="col-md-2">
                            <strong>{{ i18n.t('employee_vacations.fields.status') }}:</strong>
                            <br>
                            <app-status-badge
                              [label]="vacation.isApproved ? i18n.t('employee_vacations.approved') : i18n.t('employee_vacations.pending')"
                              [variant]="vacation.isApproved ? 'success' : 'warning'"
                              [icon]="vacation.isApproved ? 'fas fa-check-circle' : 'fas fa-hourglass-half'">
                            </app-status-badge>
                          </div>
                          <div class="col-md-2">
                            <strong>{{ i18n.t('common.created_date') }}:</strong>
                            <br>
                            <small class="text-muted">{{ formatDate(vacation.createdAtUtc) }}</small>
                          </div>
                        </div>
                        @if (vacation.notes) {
                          <div class="row mt-2">
                            <div class="col-12">
                              <strong>{{ i18n.t('employee_vacations.fields.notes') }}:</strong>
                              <p class="text-muted mb-0">{{ vacation.notes }}</p>
                            </div>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              }

              <!-- Employee Excuses -->
              @if (leaveExcuseDetails()?.excuses && leaveExcuseDetails()!.excuses.length > 0) {
                <div class="mb-4">
                  <h6 class="section-header excuse-header">
                    <i class="fas fa-clock me-2"></i>
                    {{ i18n.t('attendance.daily_detail.excuses') }}
                  </h6>
                  @for (excuse of leaveExcuseDetails()!.excuses; track excuse.id) {
                    <div class="card leave-excuse-card excuse-card border-start border-warning border-3 mb-3">
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-3">
                            <strong>{{ i18n.t('employee_excuses.fields.excuse_type') }}:</strong>
                            <br>
                            <span class="text-warning fw-bold">{{ excuse.excuseTypeDisplay }}</span>
                          </div>
                          <div class="col-md-3">
                            <strong>{{ i18n.t('employee_excuses.fields.time_period') }}:</strong>
                            <br>
                            <span class="text-muted">{{ excuse.timeRangeDisplay }}</span>
                          </div>
                          <div class="col-md-2">
                            <strong>{{ i18n.t('employee_excuses.fields.duration') }}:</strong>
                            <br>
                            <span class="text-info fw-bold">{{ excuse.durationDisplay }}</span>
                          </div>
                          <div class="col-md-2">
                            <strong>{{ i18n.t('employee_excuses.fields.status') }}:</strong>
                            <br>
                            <span [class]="getApprovalStatusBadgeClass(excuse.approvalStatusDisplay)">
                              {{ excuse.approvalStatusDisplay }}
                            </span>
                          </div>
                          <div class="col-md-2">
                            @if (excuse.hasAttachment) {
                              <strong>{{ i18n.t('employee_excuses.fields.attachment') }}:</strong>
                              <br>
                              <app-status-badge
                                [label]="i18n.t('employee_excuses.has_attachment')"
                                [variant]="'info'"
                                [icon]="'fas fa-paperclip'">
                              </app-status-badge>
                            }
                          </div>
                        </div>
                        <div class="row mt-2">
                          <div class="col-md-6">
                            <strong>{{ i18n.t('employee_excuses.fields.reason') }}:</strong>
                            <p class="text-muted mb-0">{{ excuse.reason }}</p>
                          </div>
                          @if (excuse.approvedByName) {
                            <div class="col-md-6">
                              <strong>{{ i18n.t('employee_excuses.fields.approved_by') }}:</strong>
                              <br>
                              <span class="text-success">{{ excuse.approvedByName }}</span>
                              @if (excuse.approvedAt) {
                                <br>
                                <small class="text-muted">{{ formatDate(excuse.approvedAt) }}</small>
                              }
                            </div>
                          }
                        </div>
                        @if (excuse.rejectionReason) {
                          <div class="row mt-2">
                            <div class="col-12">
                              <strong>{{ i18n.t('employee_excuses.fields.rejection_reason') }}:</strong>
                              <p class="text-danger mb-0">{{ excuse.rejectionReason }}</p>
                            </div>
                          </div>
                        }
                        @if (excuse.processingNotes) {
                          <div class="row mt-2">
                            <div class="col-12">
                              <strong>{{ i18n.t('employee_excuses.fields.processing_notes') }}:</strong>
                              <p class="text-muted mb-0">{{ excuse.processingNotes }}</p>
                            </div>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              }

              <!-- Remote Work (Future Implementation) -->
              @if (leaveExcuseDetails()?.remoteWork && leaveExcuseDetails()!.remoteWork.length > 0) {
                <div class="mb-4">
                  <h6 class="section-header remote-work-header">
                    <i class="fas fa-home me-2"></i>
                    {{ i18n.t('attendance.daily_detail.remote_work') }}
                  </h6>
                  @for (remoteWork of leaveExcuseDetails()!.remoteWork; track remoteWork.id) {
                    <div class="card leave-excuse-card remote-work-card border-start border-info border-3 mb-3">
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-3">
                            <strong>{{ i18n.t('attendance.remote_work.work_type') }}:</strong>
                            <br>
                            <span class="text-info fw-bold">{{ remoteWork.workType }}</span>
                          </div>
                          <div class="col-md-3">
                            <strong>{{ i18n.t('attendance.remote_work.location') }}:</strong>
                            <br>
                            <span class="text-muted">{{ remoteWork.workLocation }}</span>
                          </div>
                          <div class="col-md-3">
                            @if (remoteWork.startTime && remoteWork.endTime) {
                              <strong>{{ i18n.t('attendance.remote_work.time_period') }}:</strong>
                              <br>
                              <span class="text-muted">{{ remoteWork.startTime }} - {{ remoteWork.endTime }}</span>
                            }
                          </div>
                          <div class="col-md-3">
                            <strong>{{ i18n.t('attendance.remote_work.status') }}:</strong>
                            <br>
                            <app-status-badge
                              [label]="remoteWork.isApproved ? i18n.t('attendance.remote_work.approved') : i18n.t('attendance.remote_work.pending')"
                              [variant]="remoteWork.isApproved ? 'success' : 'warning'"
                              [icon]="remoteWork.isApproved ? 'fas fa-check-circle' : 'fas fa-hourglass-half'">
                            </app-status-badge>
                          </div>
                        </div>
                        @if (remoteWork.notes) {
                          <div class="row mt-2">
                            <div class="col-12">
                              <strong>{{ i18n.t('attendance.remote_work.notes') }}:</strong>
                              <p class="text-muted mb-0">{{ remoteWork.notes }}</p>
                            </div>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Additional Information -->
    @if (attendanceRecord()!.notes || attendanceRecord()!.isApproved !== undefined) {
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-sticky-note me-2"></i>
                {{ i18n.t('attendance.daily_detail.additional_info') }}
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                @if (attendanceRecord()!.notes) {
                  <div class="col-md-6">
                    <strong>{{ i18n.t('attendance.fields.notes') }}:</strong>
                    <br>
                    <p class="text-muted">{{ attendanceRecord()!.notes }}</p>
                  </div>
                }
                @if (attendanceRecord()!.isManualOverride) {
                  <div class="col-md-6">
                    <strong>{{ i18n.t('attendance.fields.manual_override') }}:</strong>
                    <br>
                    <app-status-badge
                      [label]="i18n.t('attendance.status.manual_override')"
                      [variant]="'warning'"
                      [icon]="'fas fa-hand-paper'">
                    </app-status-badge>
                  </div>
                }
              </div>
              @if (attendanceRecord()!.isApproved !== undefined) {
                <div class="row">
                  <div class="col-12">
                    <strong>{{ i18n.t('attendance.fields.approval_status') }}:</strong>
                    <br>
                    <app-status-badge
                      [label]="attendanceRecord()!.isApproved ? i18n.t('attendance.approved') : i18n.t('attendance.pending_approval')"
                      [variant]="attendanceRecord()!.isApproved ? 'success' : 'warning'"
                      [icon]="attendanceRecord()!.isApproved ? 'fas fa-check-circle' : 'fas fa-hourglass-half'">
                    </app-status-badge>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    }
  </div>
}

<!-- No Data State -->
@if (!loading() && !error() && (!employee() || !attendanceRecord())) {
  <div class="text-center py-5">
    <i class="fas fa-exclamation-circle fa-3x text-muted mb-3"></i>
    <h5 class="text-muted">{{ i18n.t('attendance.daily_detail.no_data') }}</h5>
    <p class="text-muted">{{ i18n.t('attendance.daily_detail.no_data_description') }}</p>
    <button type="button" class="btn btn-primary" (click)="onBack()">
      <i class="fas fa-arrow-left me-2"></i>
      {{ i18n.t('common.back') }}
    </button>
  </div>
}