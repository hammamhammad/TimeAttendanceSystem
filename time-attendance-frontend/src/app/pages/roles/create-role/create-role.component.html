<div class="container-fluid">
  <!-- Header -->
  <app-form-header
    mode="create"
    [title]="t('roles.create_role')"
    moduleName="roles"
    moduleRoute="roles"
    [loading]="submitting()">
  </app-form-header>

  @if (loading()) {
    <div class="d-flex justify-content-center py-5">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">{{ t('common.loading') }}</span>
      </div>
    </div>
  } @else {
    <!-- Main Form -->
    <app-form-section [title]="t('roles.role_information')">
      <div class="card-body">
        @if (error()) {
          <div class="alert alert-danger" role="alert">
            <i class="fa-solid fa-exclamation-triangle me-2"></i>
            {{ error() }}
          </div>
        }

        <form (ngSubmit)="onSubmit()">
          <!-- Basic Information Section -->
          <app-form-section [title]="t('roles.basic_information')">
            <!-- Role Name -->
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">
                  {{ t('roles.role_name') }}
                  <span class="text-danger">*</span>
                </label>
                <input
                  type="text"
                  class="form-control"
                  [(ngModel)]="roleForm.name"
                  name="roleName"
                  [placeholder]="t('roles.role_name_placeholder')"
                  [disabled]="submitting()"
                  required
                />
              </div>
            </div>
          </app-form-section>

          <hr>

          <!-- Permissions Section -->
          <app-form-section [title]="t('roles.select_permissions')">
            <div class="d-flex justify-content-end align-items-center mb-3">
              <div class="btn-group btn-group-sm" role="group">
                <button 
                  type="button" 
                  class="btn btn-outline-primary"
                  (click)="selectAllPermissions()"
                  [disabled]="submitting()"
                >
                  <i class="fa-solid fa-check-double me-1"></i>
                  {{ t('roles.select_all') }}
                </button>
                <button 
                  type="button" 
                  class="btn btn-outline-secondary"
                  (click)="clearAllPermissions()"
                  [disabled]="submitting()"
                >
                  <i class="fa-solid fa-times me-1"></i>
                  {{ t('roles.clear_all') }}
                </button>
              </div>
            </div>

            <!-- Selected permissions summary -->
            <div class="alert alert-info py-2 px-3 mb-3">
              <small>
                <i class="fa-solid fa-info-circle me-2"></i>
                {{ roleForm.selectedPermissions.size }} {{ t('roles.permissions_selected') }} {{ t('common.of') }} {{ allPermissions().length }}
              </small>
            </div>
            
            <!-- Permissions search -->
            <div class="mb-3">
              <div class="input-group">
                <span class="input-group-text">
                  <i class="fa-solid fa-search"></i>
                </span>
                <input 
                  type="text" 
                  class="form-control" 
                  [(ngModel)]="permissionSearchTerm"
                  name="permissionSearch"
                  [placeholder]="t('roles.search_permissions_placeholder')"
                  [disabled]="submitting()"
                />
              </div>
            </div>
            
            <!-- Permissions List -->
            <div class="permissions-list border rounded p-3" style="max-height: 500px; overflow-y: auto;">
              @for (group of getFilteredGroupedPermissions(); track group.group) {
                <div class="permission-group mb-4">
                  <!-- Group Header with Actions -->
                  <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                    <div class="d-flex align-items-center">
                      <!-- Collapse/Expand Button -->
                      <button
                        type="button"
                        class="btn btn-sm btn-link text-decoration-none p-0 me-2"
                        (click)="toggleGroupCollapse(group.group)"
                        [disabled]="submitting()"
                        [title]="isGroupCollapsed(group.group) ? t('common.expand') : t('common.collapse')">
                        <i class="fas" [ngClass]="isGroupCollapsed(group.group) ? 'fa-chevron-right' : 'fa-chevron-down'"></i>
                      </button>

                      <h6 class="fw-bold text-primary mb-0">
                        <i class="fas fa-layer-group me-2"></i>
                        {{ group.group }}
                        <small class="text-muted fw-normal">({{ group.permissions.length }} {{ t('roles.permissions') }})</small>
                      </h6>
                    </div>

                    <!-- Group Actions -->
                    <div class="btn-group btn-group-sm" role="group">
                      <button
                        type="button"
                        class="btn"
                        [class.btn-primary]="areAllGroupPermissionsSelected(group)"
                        [class.btn-outline-primary]="!areAllGroupPermissionsSelected(group)"
                        (click)="toggleGroupSelection(group)"
                        [disabled]="submitting()"
                        [title]="areAllGroupPermissionsSelected(group) ? t('roles.deselect_all_group') : t('roles.select_all_group')">
                        <i class="fas"
                           [ngClass]="areAllGroupPermissionsSelected(group) ? 'fa-check-square' : (areSomeGroupPermissionsSelected(group) ? 'fa-minus-square' : 'fa-square')"></i>
                        {{ areAllGroupPermissionsSelected(group) ? t('roles.deselect_all') : t('roles.select_all') }}
                      </button>
                    </div>
                  </div>

                  <!-- Permissions Grid (Collapsible) -->
                  @if (!isGroupCollapsed(group.group)) {
                    <div class="row g-3">
                    @for (permission of group.permissions; track permission.id) {
                      <div class="col-md-6 col-lg-4">
                        <div class="permission-item border rounded p-3" 
                             [class.bg-primary-subtle]="isPermissionSelectedForRole(permission.id)"
                             [class.border-primary]="isPermissionSelectedForRole(permission.id)">
                          <div class="form-check d-flex align-items-start">
                            <input
                              class="form-check-input mt-1"
                              type="checkbox"
                              [id]="'permission-' + permission.id"
                              [checked]="isPermissionSelectedForRole(permission.id)"
                              [disabled]="submitting()"
                              (change)="onTogglePermissionForRole(permission)"
                            />
                            <div class="form-check-content ms-2 flex-grow-1">
                              <div class="d-flex align-items-center mb-1">
                                <i class="fas me-2 text-muted" [ngClass]="getPermissionIcon(permission.key)" style="font-size: 0.8rem;"></i>
                                <label class="form-check-label fw-medium me-2" [for]="'permission-' + permission.id">
                                  <small>{{ getPermissionResource(permission.key) }}</small>
                                </label>
                                <span class="badge" [ngClass]="getActionBadgeClass(permission.key)" style="font-size: 0.65rem;">
                                  {{ getPermissionAction(permission.key) }}
                                </span>
                              </div>
                              <p class="text-muted small mb-0" style="font-size: 0.75rem; margin-left: 1.5rem;">
                                {{ getPermissionDescription(permission) }}
                              </p>
                            </div>
                          </div>
                        </div>
                      </div>
                    }
                    </div>
                  }
                </div>
              }
              
              @if (getFilteredGroupedPermissions().length === 0) {
                <div class="text-center py-4">
                  <i class="fa-solid fa-key fa-2x text-muted mb-2"></i>
                  <p class="text-muted mb-0">{{ t('roles.no_permissions_available') }}</p>
                </div>
              }
            </div>
          </app-form-section>

          <!-- Form Actions -->
          <div class="d-flex justify-content-end gap-2">
            <button 
              type="button" 
              class="btn btn-outline-secondary"
              (click)="onCancel()"
              [disabled]="submitting()">
              <i class="fa-solid fa-times me-2"></i>
              {{ t('common.cancel') }}
            </button>
            <button 
              type="submit" 
              class="btn btn-primary"
              [disabled]="!roleForm.name.trim() || submitting()">
              @if (submitting()) {
                <div class="spinner-border spinner-border-sm me-2"></div>
              } @else {
                <i class="fa-solid fa-save me-2"></i>
              }
              {{ submitting() ? t('roles.creating_role') : t('roles.create_role') }}
            </button>
          </div>
        </form>
      </div>
    </app-form-section>
  }
</div>