<div class="app-form-page">
  <app-form-header
    mode="edit"
    [title]="i18n.t('excuse_policies.edit_policy')"
    moduleName="excuse-policies"
    moduleRoute="excuse-policies"
    [entityId]="policyId || 0"
    [loading]="saving()">
  </app-form-header>

  <!-- Loading State -->
  @if (loading()) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">{{ i18n.t('common.loading') }}</span>
      </div>
      <p class="mt-3 text-muted">{{ i18n.t('excuse_policies.loading_details') }}</p>
    </div>
  }

  <!-- Main Form Content -->
  @if (!loading() && currentPolicy()) {
    <form [formGroup]="policyForm" (ngSubmit)="onSubmit()">
      <div class="app-desktop-sidebar">
        <!-- Main Form Content -->
        <div class="app-main-content">
          <!-- Basic Information Section -->
          <app-form-section [title]="i18n.t('excuse_policies.basic_information')">
            <div class="row">
              <!-- Branch -->
              <div class="col-md-6 mb-3">
                <label for="branchId" class="form-label">
                  {{ i18n.t('fields.branch') }}
                </label>
                <app-searchable-select
                  id="branchId"
                  formControlName="branchId"
                  [options]="branchOptions"
                  [placeholder]="i18n.t('excuse_policies.placeholders.select_branch')"
                  [isInvalid]="isFieldInvalid('branchId')">
                </app-searchable-select>
                @if (hasError('branchId')) {
                  <div class="invalid-feedback d-block">
                    {{ getErrorMessage('branchId') }}
                  </div>
                }
                <div class="form-text">
                  {{ i18n.t('excuse_policies.help.branch_selection') }}
                </div>
              </div>

              <!-- Status -->
              <div class="col-md-6 mb-3">
                <div class="form-check form-switch">
                  <input
                    type="checkbox"
                    id="isActive"
                    formControlName="isActive"
                    class="form-check-input">
                  <label for="isActive" class="form-check-label">
                    {{ i18n.t('excuse_policies.is_active') }}
                  </label>
                </div>
                <div class="form-text">
                  {{ i18n.t('excuse_policies.help.policy_status') }}
                </div>
              </div>
            </div>
          </app-form-section>

          <!-- Limits Section -->
          <app-form-section [title]="i18n.t('excuse_policies.excuse_limits')">
            <div class="row">
              <!-- Max Personal Excuses Per Month -->
              <div class="col-md-6 mb-3">
                <label for="maxPersonalExcusesPerMonth" class="form-label">
                  {{ i18n.t('excuse_policies.max_personal_excuses_per_month') }} <span class="text-danger">*</span>
                </label>
                <input
                  type="number"
                  id="maxPersonalExcusesPerMonth"
                  formControlName="maxPersonalExcusesPerMonth"
                  class="form-control"
                  [class.is-invalid]="isFieldInvalid('maxPersonalExcusesPerMonth')"
                  min="0"
                  max="31"
                  [placeholder]="i18n.t('excuse_policies.placeholders.enter_max_excuses')">
                @if (hasError('maxPersonalExcusesPerMonth')) {
                  <div class="invalid-feedback">
                    {{ getErrorMessage('maxPersonalExcusesPerMonth') }}
                  </div>
                }
              </div>

              <!-- Max Personal Excuse Hours Per Month -->
              <div class="col-md-6 mb-3">
                <label for="maxPersonalExcuseHoursPerMonth" class="form-label">
                  {{ i18n.t('excuse_policies.max_personal_excuse_hours_per_month') }} <span class="text-danger">*</span>
                </label>
                <input
                  type="number"
                  id="maxPersonalExcuseHoursPerMonth"
                  formControlName="maxPersonalExcuseHoursPerMonth"
                  class="form-control"
                  [class.is-invalid]="isFieldInvalid('maxPersonalExcuseHoursPerMonth')"
                  min="0"
                  max="744"
                  [placeholder]="i18n.t('excuse_policies.placeholders.enter_max_hours')">
                @if (hasError('maxPersonalExcuseHoursPerMonth')) {
                  <div class="invalid-feedback">
                    {{ getErrorMessage('maxPersonalExcuseHoursPerMonth') }}
                  </div>
                }
              </div>

              <!-- Max Personal Excuse Hours Per Day -->
              <div class="col-md-6 mb-3">
                <label for="maxPersonalExcuseHoursPerDay" class="form-label">
                  {{ i18n.t('excuse_policies.max_personal_excuse_hours_per_day') }} <span class="text-danger">*</span>
                </label>
                <input
                  type="number"
                  id="maxPersonalExcuseHoursPerDay"
                  formControlName="maxPersonalExcuseHoursPerDay"
                  class="form-control"
                  [class.is-invalid]="isFieldInvalid('maxPersonalExcuseHoursPerDay')"
                  min="0"
                  max="24"
                  [placeholder]="i18n.t('excuse_policies.placeholders.enter_max_daily_hours')">
                @if (hasError('maxPersonalExcuseHoursPerDay')) {
                  <div class="invalid-feedback">
                    {{ getErrorMessage('maxPersonalExcuseHoursPerDay') }}
                  </div>
                }
              </div>

              <!-- Max Hours Per Excuse -->
              <div class="col-md-6 mb-3">
                <label for="maxHoursPerExcuse" class="form-label">
                  {{ i18n.t('excuse_policies.max_hours_per_excuse') }} <span class="text-danger">*</span>
                </label>
                <input
                  type="number"
                  id="maxHoursPerExcuse"
                  formControlName="maxHoursPerExcuse"
                  class="form-control"
                  [class.is-invalid]="isFieldInvalid('maxHoursPerExcuse')"
                  min="0"
                  max="24"
                  [placeholder]="i18n.t('excuse_policies.placeholders.enter_max_excuse_hours')">
                @if (hasError('maxHoursPerExcuse')) {
                  <div class="invalid-feedback">
                    {{ getErrorMessage('maxHoursPerExcuse') }}
                  </div>
                }
              </div>
            </div>
          </app-form-section>

          <!-- Settings Section -->
          <app-form-section [title]="i18n.t('excuse_policies.policy_settings')">
            <div class="row">
              <!-- Minimum Excuse Duration -->
              <div class="col-md-6 mb-3">
                <label for="minimumExcuseDuration" class="form-label">
                  {{ i18n.t('excuse_policies.minimum_excuse_duration') }} <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <input
                    type="number"
                    id="minimumExcuseDuration"
                    formControlName="minimumExcuseDuration"
                    class="form-control"
                    [class.is-invalid]="isFieldInvalid('minimumExcuseDuration')"
                    min="1"
                    max="1440"
                    [placeholder]="i18n.t('excuse_policies.placeholders.enter_min_duration')">
                  <span class="input-group-text">{{ i18n.t('fields.minutesUnit') }}</span>
                </div>
                @if (hasError('minimumExcuseDuration')) {
                  <div class="invalid-feedback d-block">
                    {{ getErrorMessage('minimumExcuseDuration') }}
                  </div>
                }
              </div>

              <!-- Max Retroactive Days -->
              <div class="col-md-6 mb-3">
                <label for="maxRetroactiveDays" class="form-label">
                  {{ i18n.t('excuse_policies.max_retroactive_days') }} <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <input
                    type="number"
                    id="maxRetroactiveDays"
                    formControlName="maxRetroactiveDays"
                    class="form-control"
                    [class.is-invalid]="isFieldInvalid('maxRetroactiveDays')"
                    min="0"
                    max="365"
                    [placeholder]="i18n.t('excuse_policies.placeholders.enter_retroactive_days')">
                  <span class="input-group-text">{{ i18n.t('fields.daysUnit') }}</span>
                </div>
                @if (hasError('maxRetroactiveDays')) {
                  <div class="invalid-feedback d-block">
                    {{ getErrorMessage('maxRetroactiveDays') }}
                  </div>
                }
              </div>

              <!-- Policy Toggles -->
              <div class="col-12">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                      <input
                        type="checkbox"
                        id="requiresApproval"
                        formControlName="requiresApproval"
                        class="form-check-input">
                      <label for="requiresApproval" class="form-check-label">
                        {{ i18n.t('excuse_policies.requires_approval') }}
                      </label>
                    </div>
                    <div class="form-text">
                      {{ i18n.t('excuse_policies.help.requires_approval') }}
                    </div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                      <input
                        type="checkbox"
                        id="allowPartialHourExcuses"
                        formControlName="allowPartialHourExcuses"
                        class="form-check-input">
                      <label for="allowPartialHourExcuses" class="form-check-label">
                        {{ i18n.t('excuse_policies.allow_partial_hour_excuses') }}
                      </label>
                    </div>
                    <div class="form-text">
                      {{ i18n.t('excuse_policies.help.partial_hours') }}
                    </div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                      <input
                        type="checkbox"
                        id="allowSelfServiceRequests"
                        formControlName="allowSelfServiceRequests"
                        class="form-check-input">
                      <label for="allowSelfServiceRequests" class="form-check-label">
                        {{ i18n.t('excuse_policies.allow_self_service_requests') }}
                      </label>
                    </div>
                    <div class="form-text">
                      {{ i18n.t('excuse_policies.help.self_service') }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </app-form-section>
        </div>

        <!-- Sidebar Actions -->
        <div class="app-sidebar-content">
          <!-- Form Actions Card -->
          <div class="card mb-3">
            <div class="card-header">
              <h6 class="card-title mb-0">
                <i class="fas fa-cogs me-2"></i>
                {{ i18n.t('common.actions') }}
              </h6>
            </div>
            <div class="card-body">
              <div class="d-grid gap-2">
                <!-- Save Button -->
                <button
                  type="submit"
                  class="btn btn-primary"
                  [disabled]="policyForm.invalid || saving()">
                  @if (saving()) {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    {{ i18n.t('common.saving') }}
                  } @else {
                    <i class="fas fa-save me-2"></i>
                    {{ i18n.t('common.save') }}
                  }
                </button>

                <!-- Reset Button -->
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  (click)="onReset()"
                  [disabled]="saving()">
                  <i class="fas fa-undo me-2"></i>
                  {{ i18n.t('common.reset') }}
                </button>

                <!-- Cancel Button -->
                <button
                  type="button"
                  class="btn btn-outline-danger"
                  (click)="onCancel()"
                  [disabled]="saving()">
                  <i class="fas fa-times me-2"></i>
                  {{ i18n.t('common.cancel') }}
                </button>
              </div>
            </div>
          </div>

          <!-- Help Card -->
          <div class="card">
            <div class="card-header">
              <h6 class="card-title mb-0">
                <i class="fas fa-info-circle me-2"></i>
                {{ i18n.t('common.help') }}
              </h6>
            </div>
            <div class="card-body">
              <p class="card-text small text-muted mb-2">
                {{ i18n.t('excuse_policies.help.edit_instructions') }}
              </p>
              <ul class="list-unstyled small text-muted mb-0">
                <li class="mb-1">
                  <i class="fas fa-check-circle text-success me-1"></i>
                  {{ i18n.t('excuse_policies.help.required_fields') }}
                </li>
                <li class="mb-1">
                  <i class="fas fa-clock text-info me-1"></i>
                  {{ i18n.t('excuse_policies.help.time_validation') }}
                </li>
                <li>
                  <i class="fas fa-shield-alt text-warning me-1"></i>
                  {{ i18n.t('excuse_policies.help.approval_info') }}
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </form>
  }
</div>