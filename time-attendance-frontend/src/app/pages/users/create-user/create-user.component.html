<div class="container-fluid">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>{{ t('users.create_user') }}</h2>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a routerLink="/dashboard">{{ t('dashboard.title') }}</a>
          </li>
          <li class="breadcrumb-item">
            <a routerLink="/users">{{ t('users.title') }}</a>
          </li>
          <li class="breadcrumb-item active">{{ t('users.create_user') }}</li>
        </ol>
      </nav>
    </div>
    <button 
      type="button" 
      class="btn btn-outline-secondary"
      (click)="onCancel()"
      [disabled]="submitting()">
      <i class="fa-solid fa-arrow-left me-2"></i>
      {{ t('common.back') }}
    </button>
  </div>

  @if (loading()) {
    <div class="d-flex justify-content-center py-5">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">{{ t('common.loading') }}</span>
      </div>
    </div>
  } @else {
    <!-- Main Form -->
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fa-solid fa-user-plus me-2"></i>
          {{ t('users.user_information') }}
        </h5>
      </div>
      <div class="card-body">
        @if (error()) {
          <div class="alert alert-danger" role="alert">
            <i class="fa-solid fa-exclamation-triangle me-2"></i>
            {{ error() }}
          </div>
        }

        <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
          <!-- Basic Information Section -->
          <div class="mb-4">
            <h6 class="text-primary mb-3">
              <i class="fa-solid fa-asterisk me-2"></i>
              {{ t('users.basic_information') }}
            </h6>
            <div class="row g-3">
              <!-- Username -->
              <div class="col-md-6">
                <label class="form-label">
                  {{ t('users.username') }}
                  <span class="text-danger">*</span>
                </label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="username"
                  [placeholder]="t('users.username')"
                  [class.is-invalid]="isFieldInvalid('username')"
                />
                @if (isFieldInvalid('username')) {
                  <div class="invalid-feedback">{{ getFieldError('username') }}</div>
                }
              </div>

              <!-- Email -->
              <div class="col-md-6">
                <label class="form-label">
                  {{ t('users.email') }}
                  <span class="text-danger">*</span>
                </label>
                <input
                  type="email"
                  class="form-control"
                  formControlName="email"
                  [placeholder]="t('users.email')"
                  [class.is-invalid]="isFieldInvalid('email')"
                />
                @if (isFieldInvalid('email')) {
                  <div class="invalid-feedback">{{ getFieldError('email') }}</div>
                }
              </div>

              <!-- Phone -->
              <div class="col-md-6">
                <label class="form-label">{{ t('users.phone') }}</label>
                <input
                  type="tel"
                  class="form-control"
                  formControlName="phone"
                  [placeholder]="t('users.phone')"
                  [class.is-invalid]="isFieldInvalid('phone')"
                />
                @if (isFieldInvalid('phone')) {
                  <div class="invalid-feedback">{{ getFieldError('phone') }}</div>
                }
              </div>

              <!-- Password -->
              <div class="col-md-6">
                <label class="form-label">
                  {{ t('users.password') }}
                  <span class="text-danger">*</span>
                </label>
                <input
                  type="password"
                  class="form-control"
                  formControlName="password"
                  [placeholder]="t('users.password')"
                  [class.is-invalid]="isFieldInvalid('password')"
                />
                @if (isFieldInvalid('password')) {
                  <div class="invalid-feedback">{{ getFieldError('password') }}</div>
                }
                <small class="form-text text-muted">
                  {{ t('auth.password_requirements') }}
                </small>
              </div>

              <!-- Confirm Password -->
              <div class="col-md-6">
                <label class="form-label">
                  {{ t('users.confirm_password') }}
                  <span class="text-danger">*</span>
                </label>
                <input
                  type="password"
                  class="form-control"
                  formControlName="confirmPassword"
                  [placeholder]="t('users.confirm_password')"
                  [class.is-invalid]="isFieldInvalid('confirmPassword')"
                />
                @if (isFieldInvalid('confirmPassword')) {
                  <div class="invalid-feedback">{{ getFieldError('confirmPassword') }}</div>
                }
              </div>

              <!-- Preferred Language -->
              <div class="col-md-6">
                <label class="form-label">
                  {{ t('users.language') }}
                  <span class="text-danger">*</span>
                </label>
                <select
                  class="form-select"
                  formControlName="preferredLanguage"
                  [class.is-invalid]="isFieldInvalid('preferredLanguage')"
                >
                  <option value="en">{{ t('common.language_english') }}</option>
                  <option value="ar">{{ t('common.language_arabic') }}</option>
                </select>
                @if (isFieldInvalid('preferredLanguage')) {
                  <div class="invalid-feedback">{{ getFieldError('preferredLanguage') }}</div>
                }
              </div>
            </div>
          </div>

          <hr>

          <!-- Roles Section -->
          <div class="mb-4">
            <h6 class="text-primary mb-3">
              <i class="fa-solid fa-user-tag me-2"></i>
              {{ t('users.roles') }}
            </h6>
            <label class="form-label">
              {{ t('users.roles') }}
              <span class="text-danger">*</span>
            </label>
            <div class="border rounded p-3 bg-light">
              @if (availableRoles().length > 0) {
                <div class="row g-3">
                  @for (role of availableRoles(); track role.id) {
                    <div class="col-md-6 col-lg-4">
                      <div class="form-check p-2 border rounded bg-white">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          [id]="'role-' + role.id"
                          [checked]="isRoleSelected(role.id)"
                          (change)="onRoleToggle(role.id)"
                        />
                        <label class="form-check-label fw-medium" [for]="'role-' + role.id">
                          <i class="fa-solid fa-shield-alt me-2 text-primary"></i>
                          {{ role.name }}
                        </label>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="text-muted text-center py-3">
                  <i class="fa-solid fa-spinner fa-spin me-2"></i>
                  {{ t('common.loading') }}...
                </div>
              }
            </div>
            @if (isFieldInvalid('roleIds')) {
              <div class="text-danger small mt-1">
                {{ getFieldError('roleIds') }}
              </div>
            }
          </div>

          <hr>

          <!-- Branches Section -->
          <div class="mb-4">
            <h6 class="text-secondary mb-3">
              <i class="fa-solid fa-building me-2"></i>
              {{ t('users.branches') }}
            </h6>
            <label class="form-label">{{ t('users.branches') }}</label>
            <div class="border rounded p-3 bg-light">
              @if (availableBranches().length > 0) {
                <div class="row g-3">
                  @for (branch of availableBranches(); track branch.id) {
                    <div class="col-md-6 col-lg-4">
                      <div class="form-check p-2 border rounded bg-white">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          [id]="'branch-' + branch.id"
                          [checked]="isBranchSelected(branch.id)"
                          (change)="onBranchToggle(branch.id)"
                        />
                        <label class="form-check-label fw-medium" [for]="'branch-' + branch.id">
                          <i class="fa-solid fa-building me-2 text-success"></i>
                          {{ branch.name }}
                        </label>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="text-muted text-center py-3">
                  <i class="fa-solid fa-spinner fa-spin me-2"></i>
                  {{ t('common.loading') }}...
                </div>
              }
              <small class="form-text text-muted d-block mt-3 px-2">
                <i class="fa-solid fa-info-circle me-1 text-info"></i>
                {{ t('users.branches_help') }}
              </small>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="d-flex justify-content-end gap-2">
            <button 
              type="button" 
              class="btn btn-outline-secondary"
              (click)="onCancel()"
              [disabled]="submitting()">
              <i class="fa-solid fa-times me-2"></i>
              {{ t('common.cancel') }}
            </button>
            <button 
              type="submit" 
              class="btn btn-primary"
              [disabled]="userForm.invalid || submitting()">
              @if (submitting()) {
                <div class="spinner-border spinner-border-sm me-2"></div>
              } @else {
                <i class="fa-solid fa-save me-2"></i>
              }
              {{ submitting() ? t('common.creating') : t('users.create_user') }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>