<form [formGroup]="form" (ngSubmit)="onSubmit()">
  <app-form-section [title]="i18n.t('common.basicInformation')">
    <div class="row g-3">
    <!-- Branch (only for create mode) -->
    @if (!isEditMode) {
      <div class="col-md-6">
        <label class="form-label required">{{ i18n.t('branch.title') }}</label>
        <app-searchable-select
          [options]="branchSelectOptions"
          [value]="form.get('branchId')?.value?.toString() || ''"
          (selectionChange)="onBranchSelectionChange($event)"
          [placeholder]="i18n.t('branch.select')"
          [searchable]="true"
          [clearable]="false"
          [disabled]="loadingBranches()"
          [loading]="loadingBranches()"
          [class.is-invalid]="isFieldInvalid('branchId')"
        ></app-searchable-select>
        @if (isFieldInvalid('branchId')) {
          <div class="invalid-feedback">
            {{ getFieldError('branchId') }}
          </div>
        }
      </div>
    }

    <!-- Name -->
    <div class="col-md-6">
      <label class="form-label required">{{ i18n.t('department.name') }}</label>
      <input
        type="text"
        class="form-control"
        formControlName="name"
        [class.is-invalid]="isFieldInvalid('name')"
        [placeholder]="i18n.t('department.namePlaceholder')"
      />
      @if (isFieldInvalid('name')) {
        <div class="invalid-feedback">
          {{ getFieldError('name') }}
        </div>
      }
    </div>

    <!-- Arabic Name -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('department.nameAr') }}</label>
      <input
        type="text"
        class="form-control"
        formControlName="nameAr"
        [class.is-invalid]="isFieldInvalid('nameAr')"
        [placeholder]="i18n.t('department.nameArPlaceholder')"
        dir="rtl"
      />
      @if (isFieldInvalid('nameAr')) {
        <div class="invalid-feedback">
          {{ getFieldError('nameAr') }}
        </div>
      }
    </div>

    <!-- Code -->
    <div class="col-md-6">
      <label class="form-label required">{{ i18n.t('department.code') }}</label>
      <input
        type="text"
        class="form-control"
        formControlName="code"
        [class.is-invalid]="isFieldInvalid('code')"
        [placeholder]="i18n.t('department.codePlaceholder')"
        style="text-transform: uppercase;"
      />
      @if (isFieldInvalid('code')) {
        <div class="invalid-feedback">
          {{ getFieldError('code') }}
        </div>
      }
    </div>

    <!-- Parent Department -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('department.parentDepartment') }}</label>
      <app-searchable-select
        [options]="departmentSelectOptions"
        [value]="form.get('parentDepartmentId')?.value?.toString() || ''"
        (selectionChange)="onParentDepartmentSelectionChange($event)"
        [placeholder]="i18n.t('department.selectParent')"
        [searchable]="true"
        [clearable]="true"
        [disabled]="loading()"
        [loading]="loading()"
        [class.is-invalid]="isFieldInvalid('parentDepartmentId')"
      ></app-searchable-select>
      @if (isFieldInvalid('parentDepartmentId')) {
        <div class="invalid-feedback">
          {{ getFieldError('parentDepartmentId') }}
        </div>
      }
      <small class="form-text text-muted">
        {{ i18n.t('department.parentDepartmentHelp') }}
      </small>
    </div>

    <!-- Description -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('common.description') }}</label>
      <textarea
        class="form-control"
        formControlName="description"
        [class.is-invalid]="isFieldInvalid('description')"
        [placeholder]="i18n.t('department.descriptionPlaceholder')"
        rows="3"
      ></textarea>
      @if (isFieldInvalid('description')) {
        <div class="invalid-feedback">
          {{ getFieldError('description') }}
        </div>
      }
    </div>

    <!-- Arabic Description -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('department.descriptionAr') }}</label>
      <textarea
        class="form-control"
        formControlName="descriptionAr"
        [class.is-invalid]="isFieldInvalid('descriptionAr')"
        [placeholder]="i18n.t('department.descriptionArPlaceholder')"
        rows="3"
        dir="rtl"
      ></textarea>
      @if (isFieldInvalid('descriptionAr')) {
        <div class="invalid-feedback">
          {{ getFieldError('descriptionAr') }}
        </div>
      }
    </div>
    </div>
  </app-form-section>

  <!-- Additional Information -->
  <app-form-section [title]="i18n.t('department.additionalInformation')">
    <div class="row g-3">
    <!-- Manager -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('department.manager') }}</label>
      <div class="position-relative">
        <input
          type="text"
          class="form-control"
          [value]="managerSearchTerm() || getSelectedManagerName()"
          [class.is-invalid]="isFieldInvalid('managerEmployeeId')"
          [placeholder]="i18n.t('department.selectManager')"
          (input)="onManagerSearch($event)"
          (focus)="onManagerFocus()"
          (blur)="onManagerBlur()"
          [disabled]="loadingManagers()"
        />

        <!-- Loading indicator -->
        @if (loadingManagers()) {
          <div class="position-absolute top-50 end-0 translate-middle-y me-3">
            <app-loading-spinner
              [size]="'sm'"
              [showMessage]="false">
            </app-loading-spinner>
          </div>
        }

        <!-- Dropdown -->
        @if (showManagerDropdown() && !loadingManagers() && filteredManagers().length > 0) {
          <div
            class="dropdown-menu show w-100 mt-1 shadow"
            style="max-height: 200px; overflow-y: auto; position: absolute; z-index: 1050;"
          >
            @for (manager of filteredManagers(); track $index) {
              <button
                type="button"
                class="dropdown-item d-flex justify-content-between align-items-center"
                (click)="onSelectManager(manager)"
              >
                <div class="d-flex flex-column">
                  <span class="fw-medium">{{ manager.name }}</span>
                  <small class="text-muted">{{ manager.employeeNumber }}</small>
                </div>
              </button>
            }
          </div>
        }

        <!-- No results -->
        @if (showManagerDropdown() && !loadingManagers() && filteredManagers().length === 0 && managerSearchTerm()) {
          <div
            class="dropdown-menu show w-100 mt-1 shadow text-center py-3"
            style="position: absolute; z-index: 1050;"
          >
            <span class="text-muted">{{ i18n.t('common.noResultsFound') }}</span>
          </div>
        }

        <!-- No branch selected message for create mode -->
        @if (!isEditMode && showManagerDropdown() && !loadingManagers() && managers().length === 0) {
          <div
            class="dropdown-menu show w-100 mt-1 shadow text-center py-3"
            style="position: absolute; z-index: 1050;"
          >
            <span class="text-muted">{{ i18n.t('department.selectBranchFirst') }}</span>
          </div>
        }
      </div>

      @if (isFieldInvalid('managerEmployeeId')) {
        <div class="invalid-feedback">
          {{ getFieldError('managerEmployeeId') }}
        </div>
      }
      <small class="form-text text-muted">
        {{ i18n.t('department.managerHelp') }}
      </small>
    </div>

    <!-- Cost Center -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('department.costCenter') }}</label>
      <input
        type="text"
        class="form-control"
        formControlName="costCenter"
        [class.is-invalid]="isFieldInvalid('costCenter')"
        [placeholder]="i18n.t('department.costCenterPlaceholder')"
      />
      @if (isFieldInvalid('costCenter')) {
        <div class="invalid-feedback">
          {{ getFieldError('costCenter') }}
        </div>
      }
    </div>

    <!-- Location -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('department.location') }}</label>
      <input
        type="text"
        class="form-control"
        formControlName="location"
        [class.is-invalid]="isFieldInvalid('location')"
        [placeholder]="i18n.t('department.locationPlaceholder')"
      />
      @if (isFieldInvalid('location')) {
        <div class="invalid-feedback">
          {{ getFieldError('location') }}
        </div>
      }
    </div>

    <!-- Phone -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('common.phone') }}</label>
      <input
        type="tel"
        class="form-control"
        formControlName="phone"
        [class.is-invalid]="isFieldInvalid('phone')"
        [placeholder]="i18n.t('common.phonePlaceholder')"
      />
      @if (isFieldInvalid('phone')) {
        <div class="invalid-feedback">
          {{ getFieldError('phone') }}
        </div>
      }
    </div>

    <!-- Email -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('common.email') }}</label>
      <input
        type="email"
        class="form-control"
        formControlName="email"
        [class.is-invalid]="isFieldInvalid('email')"
        [placeholder]="i18n.t('common.emailPlaceholder')"
      />
      @if (isFieldInvalid('email')) {
        <div class="invalid-feedback">
          {{ getFieldError('email') }}
        </div>
      }
    </div>

    <!-- Sort Order -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('common.sortOrder') }}</label>
      <input
        type="number"
        class="form-control"
        formControlName="sortOrder"
        [class.is-invalid]="isFieldInvalid('sortOrder')"
        min="0"
      />
      @if (isFieldInvalid('sortOrder')) {
        <div class="invalid-feedback">
          {{ getFieldError('sortOrder') }}
        </div>
      }
      <small class="form-text text-muted">
        {{ i18n.t('common.sortOrderHelp') }}
      </small>
    </div>
    </div>
  </app-form-section>

  <!-- Status -->
  <app-form-section [title]="i18n.t('common.status')">
    <div class="row g-3">
    <!-- Active Status -->
    <div class="col-12">
      <div class="form-check form-switch">
        <input
          class="form-check-input"
          type="checkbox"
          formControlName="isActive"
          id="isActiveSwitch"
        />
        <label class="form-check-label" for="isActiveSwitch">
          {{ i18n.t('department.isActive') }}
        </label>
      </div>
      <small class="form-text text-muted">
        {{ i18n.t('department.isActiveHelp') }}
      </small>
    </div>
    </div>
  </app-form-section>

  <!-- Form Actions -->
  <div class="form-actions">
    <div class="d-flex justify-content-between">
      <div>
        <button
          type="button"
          class="btn btn-outline-secondary"
          (click)="onReset()"
          [disabled]="isSaving()"
        >
          <i class="fas fa-undo me-2"></i>
          {{ i18n.t('common.reset') }}
        </button>
      </div>
      <div class="d-flex gap-2">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="onCancel()"
          [disabled]="isSaving()"
        >
          <i class="fas fa-times me-2"></i>
          {{ i18n.t('common.cancel') }}
        </button>
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="form.invalid || isSaving()"
        >
          @if (isSaving()) {
            <span class="spinner-border spinner-border-sm me-2"></span>
          }
          @if (!isSaving()) {
            <i class="fas fa-save me-2"></i>
          }
          {{ isSaving() ? i18n.t('common.saving') : (isEditMode ? i18n.t('common.update') : i18n.t('common.save')) }}
        </button>
      </div>
    </div>
  </div>
</form>

<!-- Loading Overlay -->
@if (loading()) {
  <div class="loading-overlay">
    <div class="d-flex align-items-center justify-content-center h-100">
      <app-loading-spinner
        [message]="i18n.t('common.loading')"
        [variant]="'primary'"
        [centered]="true">
      </app-loading-spinner>
    </div>
  </div>
}