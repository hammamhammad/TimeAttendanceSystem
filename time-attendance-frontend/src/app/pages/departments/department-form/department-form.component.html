<form [formGroup]="form" (ngSubmit)="onSubmit()">
  <div class="row g-3">
    <!-- Basic Information -->
    <div class="col-12">
      <h6 class="section-title">
        <i class="fas fa-info-circle me-2"></i>
        {{ i18n.t('common.basicInformation') }}
      </h6>
    </div>

    <!-- Branch (only for create mode) -->
    @if (!isEditMode) {
      <div class="col-md-6">
        <label class="form-label required">{{ i18n.t('branch.title') }}</label>
        <app-searchable-select
          [options]="branchSelectOptions"
          [value]="form.get('branchId')?.value?.toString() || ''"
          (selectionChange)="onBranchSelectionChange($event)"
          [placeholder]="i18n.t('branch.select')"
          [searchable]="true"
          [clearable]="false"
          [disabled]="loadingBranches()"
          [loading]="loadingBranches()"
          [class.is-invalid]="isFieldInvalid('branchId')"
        ></app-searchable-select>
        <div class="invalid-feedback" *ngIf="isFieldInvalid('branchId')">
          {{ getFieldError('branchId') }}
        </div>
      </div>
    }

    <!-- Name -->
    <div class="col-md-6">
      <label class="form-label required">{{ i18n.t('department.name') }}</label>
      <input 
        type="text" 
        class="form-control"
        formControlName="name"
        [class.is-invalid]="isFieldInvalid('name')"
        [placeholder]="i18n.t('department.namePlaceholder')"
      />
      <div class="invalid-feedback" *ngIf="isFieldInvalid('name')">
        {{ getFieldError('name') }}
      </div>
    </div>

    <!-- Arabic Name -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('department.nameAr') }}</label>
      <input 
        type="text" 
        class="form-control"
        formControlName="nameAr"
        [class.is-invalid]="isFieldInvalid('nameAr')"
        [placeholder]="i18n.t('department.nameArPlaceholder')"
        dir="rtl"
      />
      <div class="invalid-feedback" *ngIf="isFieldInvalid('nameAr')">
        {{ getFieldError('nameAr') }}
      </div>
    </div>

    <!-- Code -->
    <div class="col-md-6">
      <label class="form-label required">{{ i18n.t('department.code') }}</label>
      <input 
        type="text" 
        class="form-control"
        formControlName="code"
        [class.is-invalid]="isFieldInvalid('code')"
        [placeholder]="i18n.t('department.codePlaceholder')"
        style="text-transform: uppercase;"
      />
      <div class="invalid-feedback" *ngIf="isFieldInvalid('code')">
        {{ getFieldError('code') }}
      </div>
    </div>

    <!-- Parent Department -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('department.parentDepartment') }}</label>
      <app-searchable-select
        [options]="departmentSelectOptions"
        [value]="form.get('parentDepartmentId')?.value?.toString() || ''"
        (selectionChange)="onParentDepartmentSelectionChange($event)"
        [placeholder]="i18n.t('department.selectParent')"
        [searchable]="true"
        [clearable]="true"
        [disabled]="loading()"
        [loading]="loading()"
        [class.is-invalid]="isFieldInvalid('parentDepartmentId')"
      ></app-searchable-select>
      <div class="invalid-feedback" *ngIf="isFieldInvalid('parentDepartmentId')">
        {{ getFieldError('parentDepartmentId') }}
      </div>
      <small class="form-text text-muted">
        {{ i18n.t('department.parentDepartmentHelp') }}
      </small>
    </div>

    <!-- Description -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('common.description') }}</label>
      <textarea 
        class="form-control"
        formControlName="description"
        [class.is-invalid]="isFieldInvalid('description')"
        [placeholder]="i18n.t('department.descriptionPlaceholder')"
        rows="3"
      ></textarea>
      <div class="invalid-feedback" *ngIf="isFieldInvalid('description')">
        {{ getFieldError('description') }}
      </div>
    </div>

    <!-- Arabic Description -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('department.descriptionAr') }}</label>
      <textarea 
        class="form-control"
        formControlName="descriptionAr"
        [class.is-invalid]="isFieldInvalid('descriptionAr')"
        [placeholder]="i18n.t('department.descriptionArPlaceholder')"
        rows="3"
        dir="rtl"
      ></textarea>
      <div class="invalid-feedback" *ngIf="isFieldInvalid('descriptionAr')">
        {{ getFieldError('descriptionAr') }}
      </div>
    </div>

    <!-- Additional Information -->
    <div class="col-12">
      <h6 class="section-title">
        <i class="fas fa-cog me-2"></i>
        {{ i18n.t('department.additionalInformation') }}
      </h6>
    </div>

    <!-- Manager -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('department.manager') }}</label>
      <div class="position-relative">
        <input
          type="text"
          class="form-control"
          [value]="managerSearchTerm() || getSelectedManagerName()"
          [class.is-invalid]="isFieldInvalid('managerEmployeeId')"
          [placeholder]="i18n.t('department.selectManager')"
          (input)="onManagerSearch($event)"
          (focus)="onManagerFocus()"
          (blur)="onManagerBlur()"
          [disabled]="loadingManagers()"
        />

        <!-- Loading indicator -->
        <div *ngIf="loadingManagers()" class="position-absolute top-50 end-0 translate-middle-y me-3">
          <div class="spinner-border spinner-border-sm" role="status">
            <span class="visually-hidden">{{ i18n.t('common.loading') }}...</span>
          </div>
        </div>

        <!-- Dropdown -->
        <div
          class="dropdown-menu show w-100 mt-1 shadow"
          *ngIf="showManagerDropdown() && !loadingManagers() && filteredManagers().length > 0"
          style="max-height: 200px; overflow-y: auto; position: absolute; z-index: 1050;"
        >
          <button
            type="button"
            class="dropdown-item d-flex justify-content-between align-items-center"
            *ngFor="let manager of filteredManagers(); let i = index"
            (click)="onSelectManager(manager)"
          >
            <div class="d-flex flex-column">
              <span class="fw-medium">{{ manager.name }}</span>
              <small class="text-muted">{{ manager.employeeNumber }}</small>
            </div>
          </button>
        </div>

        <!-- No results -->
        <div
          class="dropdown-menu show w-100 mt-1 shadow text-center py-3"
          *ngIf="showManagerDropdown() && !loadingManagers() && filteredManagers().length === 0 && managerSearchTerm()"
          style="position: absolute; z-index: 1050;"
        >
          <span class="text-muted">{{ i18n.t('common.noResultsFound') }}</span>
        </div>

        <!-- No branch selected message for create mode -->
        <div
          class="dropdown-menu show w-100 mt-1 shadow text-center py-3"
          *ngIf="!isEditMode && showManagerDropdown() && !loadingManagers() && managers().length === 0"
          style="position: absolute; z-index: 1050;"
        >
          <span class="text-muted">{{ i18n.t('department.selectBranchFirst') }}</span>
        </div>
      </div>

      <div class="invalid-feedback" *ngIf="isFieldInvalid('managerEmployeeId')">
        {{ getFieldError('managerEmployeeId') }}
      </div>
      <small class="form-text text-muted">
        {{ i18n.t('department.managerHelp') }}
      </small>
    </div>

    <!-- Cost Center -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('department.costCenter') }}</label>
      <input 
        type="text" 
        class="form-control"
        formControlName="costCenter"
        [class.is-invalid]="isFieldInvalid('costCenter')"
        [placeholder]="i18n.t('department.costCenterPlaceholder')"
      />
      <div class="invalid-feedback" *ngIf="isFieldInvalid('costCenter')">
        {{ getFieldError('costCenter') }}
      </div>
    </div>

    <!-- Location -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('department.location') }}</label>
      <input 
        type="text" 
        class="form-control"
        formControlName="location"
        [class.is-invalid]="isFieldInvalid('location')"
        [placeholder]="i18n.t('department.locationPlaceholder')"
      />
      <div class="invalid-feedback" *ngIf="isFieldInvalid('location')">
        {{ getFieldError('location') }}
      </div>
    </div>

    <!-- Phone -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('common.phone') }}</label>
      <input 
        type="tel" 
        class="form-control"
        formControlName="phone"
        [class.is-invalid]="isFieldInvalid('phone')"
        [placeholder]="i18n.t('common.phonePlaceholder')"
      />
      <div class="invalid-feedback" *ngIf="isFieldInvalid('phone')">
        {{ getFieldError('phone') }}
      </div>
    </div>

    <!-- Email -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('common.email') }}</label>
      <input 
        type="email" 
        class="form-control"
        formControlName="email"
        [class.is-invalid]="isFieldInvalid('email')"
        [placeholder]="i18n.t('common.emailPlaceholder')"
      />
      <div class="invalid-feedback" *ngIf="isFieldInvalid('email')">
        {{ getFieldError('email') }}
      </div>
    </div>

    <!-- Sort Order -->
    <div class="col-md-6">
      <label class="form-label">{{ i18n.t('common.sortOrder') }}</label>
      <input 
        type="number" 
        class="form-control"
        formControlName="sortOrder"
        [class.is-invalid]="isFieldInvalid('sortOrder')"
        min="0"
      />
      <div class="invalid-feedback" *ngIf="isFieldInvalid('sortOrder')">
        {{ getFieldError('sortOrder') }}
      </div>
      <small class="form-text text-muted">
        {{ i18n.t('common.sortOrderHelp') }}
      </small>
    </div>

    <!-- Status -->
    <div class="col-12">
      <h6 class="section-title">
        <i class="fas fa-toggle-on me-2"></i>
        {{ i18n.t('common.status') }}
      </h6>
    </div>

    <!-- Active Status -->
    <div class="col-12">
      <div class="form-check form-switch">
        <input 
          class="form-check-input" 
          type="checkbox" 
          formControlName="isActive"
          id="isActiveSwitch"
        />
        <label class="form-check-label" for="isActiveSwitch">
          {{ i18n.t('department.isActive') }}
        </label>
      </div>
      <small class="form-text text-muted">
        {{ i18n.t('department.isActiveHelp') }}
      </small>
    </div>
  </div>

  <!-- Form Actions -->
  <div class="form-actions">
    <div class="d-flex justify-content-between">
      <div>
        <button 
          type="button" 
          class="btn btn-outline-secondary"
          (click)="onReset()"
          [disabled]="isSaving()"
        >
          <i class="fas fa-undo me-2"></i>
          {{ i18n.t('common.reset') }}
        </button>
      </div>
      <div class="d-flex gap-2">
        <button 
          type="button" 
          class="btn btn-secondary"
          (click)="onCancel()"
          [disabled]="isSaving()"
        >
          <i class="fas fa-times me-2"></i>
          {{ i18n.t('common.cancel') }}
        </button>
        <button 
          type="submit" 
          class="btn btn-primary"
          [disabled]="form.invalid || isSaving()"
        >
          <span *ngIf="isSaving()" class="spinner-border spinner-border-sm me-2"></span>
          <i *ngIf="!isSaving()" class="fas fa-save me-2"></i>
          {{ isSaving() ? i18n.t('common.saving') : (isEditMode ? i18n.t('common.update') : i18n.t('common.save')) }}
        </button>
      </div>
    </div>
  </div>
</form>

<!-- Loading Overlay -->
<div class="loading-overlay" *ngIf="loading()">
  <div class="d-flex align-items-center justify-content-center h-100">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">{{ i18n.t('common.loading') }}...</span>
    </div>
  </div>
</div>