<div class="department-tree">
  <!-- Controls -->
  @if (showControls) {
    <div class="tree-controls mb-3">
      <div class="row g-2 align-items-center">
        <div class="col-md-4">
          <div class="input-group">
            <span class="input-group-text">
              <i class="fas fa-search"></i>
            </span>
            <input
              type="text"
              class="form-control"
              [placeholder]="i18n.t('common.search') + '...'"
              [value]="searchTerm()"
              (input)="onSearchChange($any($event.target).value)"
            />
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="showInactive"
              [checked]="showInactive()"
              (change)="onShowInactiveChange($any($event.target).checked)"
            />
            <label class="form-check-label" for="showInactive">
              {{ i18n.t('common.showInactive') }}
            </label>
          </div>
        </div>
        <div class="col-md-5">
          <div class="btn-group btn-group-sm">
            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="expandAll()"
              [title]="i18n.t('common.expandAll')"
            >
              <i class="fas fa-expand-arrows-alt"></i>
            </button>
            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="collapseAll()"
              [title]="i18n.t('common.collapseAll')"
            >
              <i class="fas fa-compress-arrows-alt"></i>
            </button>
            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="refresh()"
              [title]="i18n.t('common.refresh')"
            >
              <i class="fas fa-sync"></i>
            </button>
            @if (allowEdit) {
              <button
                type="button"
                class="btn btn-primary"
                (click)="onAddDepartment()"
                [title]="i18n.t('department.addDepartment')"
              >
                <i class="fas fa-plus"></i>
              </button>
            }
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Loading -->
  @if (loading()) {
    <div class="text-center p-4">
      <app-loading-spinner
        [message]="i18n.t('common.loading')"
        [centered]="true">
      </app-loading-spinner>
    </div>
  }

  <!-- Tree -->
  @if (!loading()) {
    <div class="tree-container">
      @for (node of getVisibleNodes(); track trackByNodeId($index, node)) {
        <div class="tree-node"
             [class.selected]="isSelected(node.id)"
             [class.inactive]="!node.isActive">

          <!-- Node Content -->
          <div class="node-content d-flex align-items-center p-2"
               [style]="getIndentStyle(node.indentLevel)"
               (click)="selectNode(node)">

            <!-- Expand/Collapse Button -->
            @if (node.hasChildren) {
              <button
                type="button"
                class="btn btn-sm btn-link expand-btn p-0 me-2"
                (click)="toggleNode(node.id); $event.stopPropagation()"
              >
                <i class="fas"
                   [class.fa-chevron-right]="!isExpanded(node.id)"
                   [class.fa-chevron-down]="isExpanded(node.id)"></i>
              </button>
            }

            <!-- Spacer for nodes without children -->
            @if (!node.hasChildren) {
              <div class="expand-spacer me-2"></div>
            }

            <!-- Department Icon -->
            <i class="fas fa-building me-2 text-primary"></i>

            <!-- Department Info -->
            <div class="node-info flex-grow-1">
              <div class="node-title">
                <strong>{{ node.name }}</strong>
                <span class="text-muted ms-1">({{ node.code }})</span>
                @if (!node.isActive) {
                  <span class="badge bg-light text-dark border ms-2">
                    {{ i18n.t('common.inactive') }}
                  </span>
                }
              </div>
              @if (node.description) {
                <div class="node-subtitle text-muted small">
                  {{ node.description }}
                </div>
              }
              <div class="node-meta text-muted small">
                @if (node.managerName) {
                  <span>
                    <i class="fas fa-user-tie me-1"></i>
                    {{ node.managerName }}
                  </span>
                }
                @if (node.employeeCount > 0) {
                  <span class="ms-2">
                    <i class="fas fa-users me-1"></i>
                    {{ node.employeeCount }} {{ i18n.t('common.employees') }}
                  </span>
                }
                @if (node.location) {
                  <span class="ms-2">
                    <i class="fas fa-map-marker-alt me-1"></i>
                    {{ node.location }}
                  </span>
                }
              </div>
            </div>

            <!-- Action Buttons -->
            @if (showControls) {
              <div class="node-actions">
                <div class="btn-group btn-group-sm">
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    (click)="onViewDepartment(node); $event.stopPropagation()"
                    [title]="i18n.t('common.view')"
                  >
                    <i class="fas fa-eye"></i>
                  </button>
                  @if (allowEdit) {
                    <button
                      type="button"
                      class="btn btn-outline-success"
                      (click)="onAddDepartment(node); $event.stopPropagation()"
                      [title]="i18n.t('department.addSubDepartment')"
                    >
                      <i class="fas fa-plus"></i>
                    </button>
                  }
                  @if (allowEdit) {
                    <button
                      type="button"
                      class="btn btn-outline-secondary"
                      (click)="onEditDepartment(node); $event.stopPropagation()"
                      [title]="i18n.t('common.edit')"
                    >
                      <i class="fas fa-edit"></i>
                    </button>
                  }
                  @if (allowDelete && node.employeeCount === 0) {
                    <button
                      type="button"
                      class="btn btn-outline-danger"
                      (click)="onDeleteDepartment(node); $event.stopPropagation()"
                      [title]="i18n.t('common.delete')"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Empty State -->
      @if (getVisibleNodes().length === 0) {
        <div class="text-center p-4 text-muted">
          <i class="fas fa-building fa-3x mb-3"></i>
          <h5>{{ i18n.t('department.noDepartments') }}</h5>
          <p>{{ i18n.t('department.noDepartmentsDescription') }}</p>
          @if (allowEdit) {
            <button
              type="button"
              class="btn btn-primary"
              (click)="onAddDepartment()"
            >
              <i class="fas fa-plus me-2"></i>
              {{ i18n.t('department.addFirstDepartment') }}
            </button>
          }
        </div>
      }
    </div>
  }
</div>