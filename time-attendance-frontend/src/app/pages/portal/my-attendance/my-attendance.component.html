<!-- Page Header -->
<app-page-header
  [title]="i18n.t('portal.my_attendance')">
  <div header-actions>
    <button
      class="btn btn-outline-primary btn-sm"
      (click)="refresh()"
      [disabled]="loading()"
      type="button">
      <i class="fa-solid fa-sync-alt" [class.fa-spin]="loading()"></i>
      {{ i18n.t('common.refresh') }}
    </button>
  </div>
</app-page-header>

<!-- Loading State -->
@if (loading() && !attendance().length) {
  <app-loading-spinner [message]="i18n.t('common.loading')"></app-loading-spinner>
}

<!-- Error State -->
@if (error() && !attendance().length) {
  <div class="alert alert-danger" role="alert">
    <i class="fa-solid fa-exclamation-triangle me-2"></i>
    {{ error() }}
    <button class="btn btn-sm btn-outline-danger ms-3" (click)="refresh()" type="button">
      {{ i18n.t('common.retry') }}
    </button>
  </div>
}

<!-- Summary Cards -->
@if (summary()) {
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="card summary-card h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-2">
            <div class="summary-icon bg-primary-subtle me-3">
              <i class="fa-solid fa-percentage text-primary"></i>
            </div>
            <div class="flex-grow-1">
              <h6 class="mb-0 text-muted">{{ i18n.t('attendance.attendance_rate') }}</h6>
              <h3 class="mb-0">{{ summary()!.attendanceRate.toFixed(1) }}%</h3>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card summary-card h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-2">
            <div class="summary-icon bg-success-subtle me-3">
              <i class="fa-solid fa-check text-success"></i>
            </div>
            <div class="flex-grow-1">
              <h6 class="mb-0 text-muted">{{ i18n.t('attendance.present_days') }}</h6>
              <h3 class="mb-0">{{ summary()!.presentDays }} / {{ summary()!.totalDays }}</h3>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card summary-card h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-2">
            <div class="summary-icon bg-info-subtle me-3">
              <i class="fa-solid fa-clock text-info"></i>
            </div>
            <div class="flex-grow-1">
              <h6 class="mb-0 text-muted">{{ i18n.t('attendance.working_hours') }}</h6>
              <h3 class="mb-0">{{ summary()!.totalWorkingHours.toFixed(1) }}h</h3>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card summary-card h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-2">
            <div class="summary-icon bg-warning-subtle me-3">
              <i class="fa-solid fa-business-time text-warning"></i>
            </div>
            <div class="flex-grow-1">
              <h6 class="mb-0 text-muted">{{ i18n.t('attendance.overtime') }}</h6>
              <h3 class="mb-0">{{ summary()!.totalOvertimeHours.toFixed(1) }}h</h3>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
}

<!-- Filters -->
<div class="card mb-4">
  <div class="card-header bg-white">
    <h5 class="card-title mb-0">
      <i class="fa-solid fa-filter me-2"></i>
      {{ i18n.t('common.filters') }}
    </h5>
  </div>
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">{{ i18n.t('common.start_date') }}</label>
        <input
          type="date"
          class="form-control"
          [(ngModel)]="startDate"
          (change)="applyFilters()">
      </div>
      <div class="col-md-4">
        <label class="form-label">{{ i18n.t('common.end_date') }}</label>
        <input
          type="date"
          class="form-control"
          [(ngModel)]="endDate"
          (change)="applyFilters()">
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button
          class="btn btn-outline-secondary w-100"
          (click)="clearFilters()"
          type="button">
          <i class="fa-solid fa-times me-2"></i>
          {{ i18n.t('common.clear_filters') }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Attendance Table -->
@if (attendance().length > 0) {
  <div class="card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0">
        <i class="fa-solid fa-table me-2"></i>
        {{ i18n.t('attendance.attendance_records') }}
      </h5>
      <span class="badge bg-primary rounded-pill">{{ attendance().length }} {{ i18n.t('common.records') }}</span>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>{{ i18n.t('common.date') }}</th>
              <th>{{ i18n.t('common.status') }}</th>
              <th>{{ i18n.t('attendance.check_in') }}</th>
              <th>{{ i18n.t('attendance.check_out') }}</th>
              <th>{{ i18n.t('attendance.working_hours') }}</th>
              <th>{{ i18n.t('attendance.overtime') }}</th>
              <th>{{ i18n.t('attendance.shift') }}</th>
            </tr>
          </thead>
          <tbody>
            @for (record of attendance(); track record.id) {
              <tr>
                <td>{{ formatDate(record.date) }}</td>
                <td>
                  <span [class]="getStatusBadgeClass(record.status)">
                    {{ record.status }}
                  </span>
                </td>
                <td>{{ formatTime(record.checkInTime) }}</td>
                <td>{{ formatTime(record.checkOutTime) }}</td>
                <td>{{ formatHours(record.workingHours || 0) }}</td>
                <td>{{ formatHours((record.preShiftOvertimeHours || 0) + (record.postShiftOvertimeHours || 0)) }}</td>
                <td>{{ record.shiftName || '-' }}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>
} @else if (!loading()) {
  <app-empty-state
    icon="fa-calendar-alt"
    [title]="i18n.t('attendance.no_records')"
    [message]="i18n.t('attendance.no_records_message')">
  </app-empty-state>
}
